<?

if (stristr($_SERVER[SCRIPT_NAME],"/header.php"))
{
	Header("Location: ./index.php?changepage=index");
	exit;
}

if ($USER[oldpwd] && !stristr($_SERVER[SCRIPT_NAME],"/preferences.php") && $PWD_MUST_CHANGE)
{
	Save_Msg("<b>YOU MUST CHANGE YOUR PASSWORD BEFORE STARTING THE GAME!!","red");
	Go("preferences.php");
}

$news = (mysql_num_rows(mysql_query("SELECT id FROM $TABLE[news] WHERE uid='$UID' AND seen='0' LIMIT 1"))) ? "<img src=\"images/mNews.png\" border=0>" : "News";
$mail = (mysql_num_rows(mysql_query("SELECT id FROM $TABLE[mail] WHERE uid='$UID' AND seen='0' LIMIT 1"))) ? "<img src=\"images/mMail.png\" border=0>" : "Mail";
$curleader = mysql_fetch_assoc(mysql_query("SELECT x,y,planetname FROM $TABLE[users] ORDER BY score DESC LIMIT 1"));

$st = explode("/",$_SERVER[SCRIPT_FILENAME]);
$stF = str_replace(".php","",$st[count($st)-1]);
$st = explode(".",strtoupper($stF));
$st = $st[0];
for ($i=0;$i<strlen($st);$i++)
{
	$subtitle .= $st{$i}." ";
}

foreach ($constructionarray AS $a => $b)
{
	if (${'c_'.$a}>1)
	{
		$current_C[vn] = $a;
		$current_C[eta] = ${'c_'.$a}-1;
		$current_C[name] = $b[0];
		break;
	}
}
foreach ($researcharray AS $a => $b)
{
	if (${'r_'.$a}>1)
	{
		$current_R[vn] = $a;
		$current_R[eta] = ${'r_'.$a}-1;
		$current_R[name] = $b[0];
		break;
	}
}

$maxlength = 76; // 100%
$length_R=0;
if ($current_R[vn])
{
	$eta_R1 = $current_R[eta];
	$eta_R2 = $researcharray[$current_R[vn]][2];
	$length_R = floor($maxlength - $eta_R1 / $eta_R2 * $maxlength);
	$length_R = max(1,$length_R);
}
$length_C=0;
if ($current_C[vn])
{
	$eta_C1 = $current_C[eta];
	$eta_C2 = $constructionarray[$current_C[vn]][2];
	$length_C = floor($maxlength - ($eta_C1/$eta_C2*$maxlength));
	$length_C = max(1,$length_C);
}

$num_galaxy_attackers = mysql_num_rows(mysql_query("SELECT id FROM $TABLE[fleets] WHERE destination_x='$USER[x]' AND purpose='attack'"));
$num_galaxy_defenders = mysql_num_rows(mysql_query("SELECT id FROM $TABLE[fleets] WHERE destination_x='$USER[x]' AND purpose='defend'"));

?>
<html>

<head>
<title><?=$GAMENAME?> <?ereg_replace("www.","",$_SERVER[HTTP_HOST])?></title>
<link rel=stylesheet href="css/styles.css">
</head>

<body leftmargin=4 topmargin=4 rightmargin=0 bottommargin=0 bgcolor=black>
<table border=0 cellpadding=0 cellspacing=0 width=700>
<tr valign=top>
<td>
<table border=0 cellpadding=0 cellspacing=0 width=700 height=180>
<tr><td><table border=0 cellpadding=5 cellspacing=0 height=60><tr valign=middle><td width=100><table border=0 cellpadding=2 cellspacing=0 width=100% height=100%><tr valign=middle><td style='border-right:solid 1px #444444;border-bottom:solid 1px #444444;cursor:pointer;color:#ee8800;' OnMouseOver="this.bgColor='#333333';" OnMouseOut="this.bgColor='#000000';" OnClick="location='news.php';"><center><?=$news?></td></tr><tr><td style='border-right:solid 1px #444444;border-bottom:solid 1px #444444;cursor:pointer;color:#ee8800;' OnMouseOver="this.bgColor='#333333';" OnMouseOut="this.bgColor='#000000';" OnClick="location='mail.php';"><center><?=$mail?></td></tr></table></td><td width=400><table border=0 cellpadding=2 cellspacing=0 width=100% height=100%><tr valign=middle><td><center><b><font color=#77ddcc style='font-size:24;' OnClick="location='<?=$_SERVER[SCRIPT_NAME]?><?=($_SERVER[QUERY_STRING])?"?".$_SERVER[QUERY_STRING]:""?>';"><?=trim($subtitle)?></font></td></tr></table></td><td width=200><table border=0 cellpadding=2 cellspacing=0 width=100% height=100%><tr valign=middle><td align=right><?=($tickdif > $TICKERTIME) ? "<font color=red>":""?><?=($tickdif>60) ? floor($tickdif/60)."+ min":" $tickdif sec"?> since last tick (<?=$TICKERTIME?> s.)</font>&nbsp;<br><font style='font-size:3px;'><br></font><?=($tickdif >= 6+$TICKERTIME || $tickdif >= 2*$TICKERTIME)?"<font color=red><b>Ticker stopped!</b></font>":"<b>Ticker Rollin'..."?>&nbsp;<br></td></tr></table></td></tr></table></td></tr>
<tr><td><table border=0 cellpadding=5 cellspacing=0 height=60><tr valign=middle><td width=550 colspan=2><?="<table border=0 cellpadding=2 cellspacing=0 width=100% height=100%><tr><td><center><font color=$showcolors[metal]><b>Metal</td><td><center><font color=$showcolors[crystal]><b>Crystal</td><td><center><b><font color=$showcolors[energy]>Energy</td><td><center><b>Score</td><td><center><b>Rank</td></tr><tr><td><center><font color=$showcolors[metal]><b>".nummertje($USER[metal])."</td><td><center><font color=$showcolors[crystal]><b>".nummertje($USER[crystal])."</td><td><center><b><font color=$showcolors[energy]>".nummertje($USER[energy])."</td><td><center>".nummertje($USER[score])."</td><td><center># $USER[rank]</td></tr><tr><td colspan=5 align=right>"?><?=($_SESSION[ps_msg])?"<b><font color=".$_SESSION[ps_msg][color].">".$_SESSION[ps_msg][msg]."</font>":"<font color=lime><b><i>$USER[rulername] of $USER[planetname] ($USER[x]:$USER[y])"?><br></td></tr></table></td><td width=150><table border=0 cellpadding=2 cellspacing=0 width=100% height=100%><tr valign=middle><td align=right>Game Time&nbsp;<br><b><?=date('D H:i:s')?></b>&nbsp;<br><br>MyT - <b><?=$MyT?>&nbsp;</td></tr></table></td></tr></table></td></tr>
<tr><td><table border=0 cellpadding=5 cellspacing=0 height=60><tr valign=middle><td width=200><table border=0 cellpadding=2 cellspacing=0 width=100% height=100%><tr valign=middle><td style='border-left:solid 1px #444444;border-bottom:solid 1px #444444;'>&nbsp;<?=($num_galaxy_attackers)?"<font color=red><b>GALAXY HOSTILES ($num_galaxy_attackers)":"<font color=#222222>Galaxy Hostiles"?></td></tr><tr><td style='border-right:solid 1px #444444;'>&nbsp;<?=($num_galaxy_defenders)?"<font color=green><b>GALAXY FRIENDLIES ($num_galaxy_defenders)":"<font color=#222222>Galaxy Friendlies"?></td></tr></table></td><td width=340><table border=0 cellpadding=2 cellspacing=0 width=100% height=100%><tr valign=middle><td width=1 rowspan=2><table border=0 cellpadding=0 cellspacing=0><tr valign=middle><td align=left background="./images/bars_bg.bmp" width=124 height=48><img src="./images/blank.gif" width=124 height=13 border=0><br>
<img src="./images/blank.gif" width=35 height=9 border=0><img src="./images/bg_R.bmp" width=<?=$length_R?> height=9 border=0><br>
<img src="./images/blank.gif" width=124 height=6 border=0><br>
<img src="./images/blank.gif" width=35 height=9 border=0><img src="./images/bg_C.bmp" width=<?=$length_C?> height=9 border=0><br>
<img src="./images/blank.gif" width=124 height=11 border=0><br></td></tr></table></td><td valign=bottom><b><font color=#ffb0b0><?=($current_R[name])?$current_R[name]." ($current_R[eta])":(($USER[all_res_done])?"No More Open Researches":"None")?></td></tr><tr><td valign=top><font color=lightgreen><b><?=($current_C[name])?$current_C[name]." ($current_C[eta])":(($USER[all_con_done])?"No More Open Constructions":"None")?></td></tr></table></td><td width=220><table border=0 cellpadding=2 cellspacing=0 width=100% height=100%><tr valign=middle><td align=right>Current leader&nbsp;<br><font style='font-size:3px;'><br></font><b><?=$curleader[planetname]?> (<?=$curleader[x]?>:<?=$curleader[y]?>)</b>&nbsp;</td></tr></table></td></tr></table></td></tr>
</table>

<table border=0 cellpadding=5 cellspacing=0 width=100%>
<tr valign=middle><td>
<?

$result = mysql_query("SELECT *,ABS(infinitys+wraiths+warfrigs+astropods+cobras+destroyers+antennas) AS num_ships FROM $TABLE[fleets] WHERE destination_id='$UID' AND destination_x='$USER[x]' AND purpose='attack'") or die(mysql_error());
while ($l = mysql_fetch_assoc($result))
{
	$a++;
	$eta = ($l[eta]>=0 && $l[actiontime]==$l[startactiontime]) ? "ETA: $l[eta] ticks" : "$l[actiontime] more ticks";
	echo "<font color=red><b>Hostile incoming fleet of ".nummertje($l[num_ships])." units from <b>".$userarray[$l[owner_id]]." of ".$planetarray[$l[owner_id]]."</b> ($l[owner_x]:$l[owner_y]) ($eta)</b></font><br>";
}

$result = mysql_query("SELECT *,ABS(infinitys+wraiths+warfrigs+astropods+cobras+destroyers+antennas) AS num_ships FROM $TABLE[fleets] WHERE destination_id='$UID' AND destination_x='$USER[x]' AND purpose='defend'") or die(mysql_error());
while ($l = mysql_fetch_assoc($result))
{
	$a++;
	$eta = ($l[eta]>=0 && $l[actiontime]==$l[startactiontime]) ? "ETA: $l[eta] ticks" : "$l[actiontime] more ticks";
	echo "<font color=green><b>Friendly incoming fleet of ".nummertje($l[num_ships])." units from <b>".$userarray[$l[owner_id]]." of ".$planetarray[$l[owner_id]]."</b> ($l[owner_x]:$l[owner_y]) ($eta)</b></font><br>";
}
echo (!$a) ? "<br>" : "";

?>
</td></tr></table>


