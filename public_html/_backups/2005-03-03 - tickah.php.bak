<?

include("config.php");

echo "<title>TICKER</title>";

$refreshingtime = ($TICKERTIME>5) ? round($TICKERTIME/2) : $TICKERTIME;

if (!$GAMEPREFS[ticker_on])
{
	if (!$MyT)
		die("<META http-equiv=refresh content=$refreshingtime>Ticker has not yet started. Sign up and join the game!");
	else
		die("<META http-equiv=refresh content=$refreshingtime>Ticker is temporarily disabled.");
}

if ($GAMEPREFS[tickcount] >= $GAMEPREFS[general_gamestoptick] && $GAMEPREFS[general_gamestoptick])
{
	$r = mysql_fetch_assoc(mysql_query("SELECT id,username,x,y,score FROM $TABLE[users] ORDER BY rank LIMIT 1"));
	die("You wont believe, but the game has STOPPED! The winner:<br><b>$r[username] #$r[id] from ($r[x],$r[y]) with ".nummertje($r[score])." points.");
}


$pw = "adminn";
if ($password != $pw && $_SERVER[HTTP_HOST] != "localhost" && $_SERVER[REMOTE_ADDR] != "80.126.42.215" && $GAMEPREFS[pwd_voor_ticker])
{
	die("Password error!");
}


ob_start();



if ($tickdif<$tickertime-1 && $override!="true")
{
	die("<META http-equiv=refresh content=$refreshingtime>Less than $tickertime seconds since last tick!");
}

$fp = fopen("ticker.dat","w");
fputs($fp,time());
fclose($fp);

Function Roids_capped($pods,$croids,$mroids,$uiroids,$num_attackers)
{
	$percent = 0.12;
	$aroids = $croids + $mroids + $uiroids;
	if ($pods>($percent * $aroids))
	{
		$roids[crystal] = floor($croids * $percent);
		$roids[metal] = floor($mroids * $percent);
		$roids[ui] = floor($uiroids * $percent);

		return $roids;
	}
	else
	{
		$roids[crystal] = floor(($croids / $aroids) * $pods);
		$roids[metal] = floor(($mroids / $aroids) * $pods);
		$roids[ui] = floor(($uiroids / $aroids) * $pods);

		return $roids;
	}
}

Function dbr($txt)
{
	global $dbr;

	$dbr = $dbr.$txt;
}

unset($dbr);

// RESEARCHES // SECTION A
mysql_query("UPDATE $TABLE[users] SET r_scan1=r_scan1-1 WHERE r_scan1>1") or die("error_AA".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_scan2=r_scan2-1 WHERE r_scan2>1") or die("error_AB".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_scan3=r_scan3-1 WHERE r_scan3>1") or die("error_AC".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_scan4=r_scan4-1 WHERE r_scan4>1") or die("error_AD".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_scan5=r_scan5-1 WHERE r_scan5>1") or die("error_AE".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_crystal15=r_crystal15-1 WHERE r_crystal15>1") or die("error_AF".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_crystal25=r_crystal25-1 WHERE r_crystal25>1") or die("error_AG".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_metal15=r_metal15-1 WHERE r_metal15>1") or die("error_AH".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_metal25=r_metal25-1 WHERE r_metal25>1") or die("error_AI".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_pwarast=r_pwarast-1 WHERE r_pwarast>1") or die("error_AJ".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_pcob=r_pcob-1 WHERE r_pcob>1") or die("error_AK".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_energy=r_energy-1 WHERE r_energy>1") or die("error_AL".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_wblockers=r_wblockers-1 WHERE r_wblockers>1") or die("error_AM".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_abot=r_abot-1 WHERE r_abot>1") or die("error_AN".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_abot2=r_abot2-1 WHERE r_abot2>1") or die("error_AO".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_enef=r_enef-1 WHERE r_enef>1") or die("error_AP".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_timt=r_timt-1 WHERE r_timt>1") or die("error_AO".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_timt2=r_timt2-1 WHERE r_timt2>1") or die("error_AO".mysql_error());
mysql_query("UPDATE $TABLE[users] SET r_rebo=r_rebo-1 WHERE r_rebo>1") or die("error_AP".mysql_error());

// CONSTRUCTIONS // SECTION B
mysql_query("UPDATE $TABLE[users] SET c_crystal10=c_crystal10-1 WHERE c_crystal10>1") or die("error_BA".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_crystal20=c_crystal20-1 WHERE c_crystal20>1") or die("error_BB".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_crystal30=c_crystal30-1 WHERE c_crystal30>1") or die("error_BC".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_metal10=c_metal10-1 WHERE c_metal10>1") or die("error_BD".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_metal20=c_metal20-1 WHERE c_metal20>1") or die("error_BE".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_metal30=c_metal30-1 WHERE c_metal30>1") or die("error_BF".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_bscan=c_bscan-1 WHERE c_bscan>1") or die("error_BG".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_uscan=c_uscan-1 WHERE c_uscan>1") or die("error_BH".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_pscan=c_pscan-1 WHERE c_pscan>1") or die("error_BI".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_mscan=c_mscan-1 WHERE c_mscan>1") or die("error_BJ".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_nscan=c_nscan-1 WHERE c_nscan>1") or die("error_BK".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_pinf=c_pinf-1 WHERE c_pinf>1") or die("error_BL".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_pwra=c_pwra-1 WHERE c_pwra>1") or die("error_BM".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_pdes=c_pdes-1 WHERE c_pdes>1") or die("error_BN".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_psco=c_psco-1 WHERE c_psco>1") or die("error_BO".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_pdu1=c_pdu1-1 WHERE c_pdu1>1") or die("error_BP".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_pdu2=c_pdu2-1 WHERE c_pdu2>1") or die("error_BQ".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_energy=c_energy-1 WHERE c_energy>1") or die("error_BR".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_wblockers=c_wblockers-1 WHERE c_wblockers>1") or die("error_BS".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_abot=c_abot-1 WHERE c_abot>1") or die("error_BT".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_enef=c_enef-1 WHERE c_enef>1") or die("error_BU".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_timt=c_timt-1 WHERE c_timt>1") or die("error_BS".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_rebo=c_rebo-1 WHERE c_rebo>1") or die("error_BS".mysql_error());
mysql_query("UPDATE $TABLE[users] SET c_rebo2=c_rebo2-1 WHERE c_rebo2>1") or die("error_BS".mysql_error());

// MISC 1 // SECTION C
mysql_query("UPDATE $TABLE[users] SET lastsleep=lastsleep-1 WHERE lastsleep>0") or die("error_CA".mysql_error());
mysql_query("UPDATE $TABLE[users] SET sleep=sleep-1 WHERE sleep>0") or die("error_CB".mysql_error());
mysql_query("UPDATE $TABLE[users] SET newbie=newbie-1 WHERE newbie>0 AND lastaction>0") or die("error_CC".mysql_error());
mysql_query("UPDATE $TABLE[production] SET eta=eta-1 WHERE eta>0") or die("error_CD".mysql_error());

mysql_query("UPDATE $TABLE[fleets] SET purpose='',eta=0,starteta=0,actiontime=0,startactiontime=0,destination_id=0,destination_x=0,destination_y=0 WHERE eta=0 AND purpose='return'"); // Klaar met returnen -> army weer klaar
mysql_query("UPDATE $TABLE[fleets] SET eta=eta-1 WHERE eta>0");
// Recall fleets with 0 ships:
mysql_query("UPDATE $TABLE[fleets] SET destination_id=0,destination_x=0,destination_y=0,purpose='',eta=0,starteta=0,actiontime=0,startactiontime=0 WHERE infinitys=0 AND wraiths=0 AND warfrigs=0 AND astropods=0 AND cobras=0 AND destroyers=0 AND scorpions=0 AND antennas=0 AND fleetname!='base'") or die("error_X2".mysql_error());
mysql_query("UPDATE $TABLE[fleets] SET destination_id=0,destination_x=0,destination_y=0,purpose='return',eta=starteta,starteta=0,actiontime=0,startactiontime=0 WHERE actiontime=0 AND eta=0 AND fleetname!='base' AND purpose!=''");

// MISC 2 // SECTION D
mysql_query("UPDATE $TABLE[users] SET energy=energy+(energyplants*40)+(powerplantsX*65)") or die("error_DA".mysql_error());


// Deletes UNUSED accounts (After 48 hours of inactivity)
// mysql_query("DELETE FROM $TABLE[users] WHERE lastaction<".(time()-3600*48) AND lastaction>0 AND vacation=0 AND roids<3) or die("error_X1".mysql_error());

// NEWS deleten uit elke user zn tabel (alleen laatste 24 uur is OK)
$okaytime = time()-(24*60*60);
mysql_query("DELETE FROM $TABLE[news] WHERE time<$okaytime AND seen='1'") or die("error_X3".mysql_error());







$result = mysql_query("SELECT * FROM $TABLE[users] ORDER BY x,y") or die("error_X5".mysql_error());
while ($myrow = mysql_fetch_array($result))
{
	$id		= $myrow[id];
	$username	= $myrow[username];
	$g_rulername	= $myrow[rulername];
	$g_planetname	= $myrow[planetname];
	$g_x		= $myrow[x];
	$g_y		= $myrow[y];

	$r_scan1	= $myrow[r_scan1];
	$r_scan2	= $myrow[r_scan2];
	$r_scan3	= $myrow[r_scan3];
	$r_scan4	= $myrow[r_scan4];
	$r_scan5	= $myrow[r_scan5];
	$r_crystal15	= $myrow[r_crystal15];
	$r_crystal25	= $myrow[r_crystal25];
	$r_metal15	= $myrow[r_metal15];
	$r_metal25	= $myrow[r_metal25];
	$r_pwarast	= $myrow[r_pwarast];
	$r_pcob		= $myrow[r_pcob];
	$r_energy	= $myrow[r_energy];

	$c_crystal10	= $myrow[c_crystal10];
	$c_crystal20	= $myrow[c_crystal20];
	$c_crystal30	= $myrow[c_crystal30];
	$c_metal10	= $myrow[c_metal10];
	$c_metal20	= $myrow[c_metal20];
	$c_metal30	= $myrow[c_metal30];
	$c_bscan	= $myrow[c_bscan];
	$c_uscan	= $myrow[c_uscan];
	$c_pscan	= $myrow[c_pscan];
	$c_mscan	= $myrow[c_mscan];
	$c_nscan	= $myrow[c_nscan];
	$c_pinf		= $myrow[c_pinf];
	$c_pwra		= $myrow[c_pwra];
	$c_pdes		= $myrow[c_pdes];
	$c_psco		= $myrow[c_psco];
	$c_pdu1		= $myrow[c_pdu1];
	$c_pdu2		= $myrow[c_pdu2];
	$c_energy	= $myrow[c_energy];

	$lstalkers	= $myrow[lstalkers];
	$avengers	= $myrow[avengers];
	$rcannons	= $myrow[rcannons];

	$crystal	= $myrow[crystal];
	$metal		= $myrow[metal];

	$size		= $myrow[size];
	$crystalroid	= $myrow[asteroid_crystal];
	$metalroid	= $myrow[asteroid_metal];
	$asteroid_ui	= $myrow[asteroid_ui];
	$roids		= $crystalroid + $metalroid + $asteroid_ui;
	$i_roids	= $crystalroid + $metalroid;


// RESOURCES //

	$crystalincome = 0;
	$crystalincome += res_per_type($crystalroid);
	$crystalincome *= ($c_rebo==1 && $c_rebo2==1 && $r_rebo==1) ? 1.15 : 1;
	$crystalincome += ($c_crystal10==1) ? 1500 : 0;
	$crystalincome += ($c_crystal20==1) ? 3000 : 0;
	$crystalincome += ($c_crystal30==1) ? 6000 : 0;

	$metalincome = 0;
	$metalincome += res_per_type($metalroid);
	$metalincome *= ($c_rebo==1 && $c_rebo2==1 && $r_rebo==1) ? 1.15 : 1;
	$metalincome += ($c_metal10==1) ? 1500 : 0;
	$metalincome += ($c_metal20==1) ? 3000 : 0;
	$metalincome += ($c_metal30==1) ? 6000 : 0;
	mysql_query("UPDATE $TABLE[users] SET metal=metal+$metalincome, crystal=crystal+$crystalincome WHERE id='$id'") or die("error_X6".mysql_error());


// PRODUCTION // SECTION E

	$prod = mysql_query("SELECT * FROM $TABLE[production] WHERE uid='$id' AND eta='0'") or die("error_EC".mysql_error());
	while ($pi = mysql_fetch_assoc($prod))
	{
		if ($pi[u_of_w] == "w" || $pi[unit]=="rcannons" || $pi[unit]=="avengers" || $pi[unit]=="lstalkers")
		{	// Het zijn GEEN schepen, die klaar zijn -> in TABLE users
			$sql = "UPDATE $TABLE[users] SET $pi[unit]=$pi[unit]+$pi[number] WHERE id='$pi[uid]'";
		}
		else
		{	// Het zijn schepen, die klaar zijn -> in TABLE fleets
			$sql = "UPDATE $TABLE[fleets] SET $pi[unit]=$pi[unit]+$pi[number] WHERE owner_id='$pi[uid]' AND fleetname='base'";
		}
		mysql_query($sql) or die("error_EA".mysql_error());
		mysql_query("DELETE FROM $TABLE[production] WHERE id='$pi[id]' AND uid='$pi[uid]' AND eta=0") or die("error_EB".mysql_error());
	}




















// COMBAT // SECTION F


	// De info van de personen die $id AANVALLEN
	$attackers_list = mysql_query("SELECT * FROM $TABLE[fleets] WHERE destination_id='$id' AND eta='0' AND purpose='attack' AND actiontime>0 ORDER BY astropods") or die("error_FA".mysql_error());
	if (mysql_num_rows($attackers_list)>0)
	{
		echo "Er wordt gevochten op dit moment... Er zijn ".mysql_num_rows($attackers_list)." aanvallers!<br><br><br>";
	# Prepare attacking fleets
		$infinitys = 0;
		$wraiths = 0;
		$warfrigs = 0;
		$astropods = 0;
		$destroyers = 0;
		$cobras = 0;
		$scorpions = 0;
		$antennas = 0;

		$i = 0;
		$attack = Array();
		while ($ai = mysql_fetch_array($attackers_list))
		{
			$attack[$i][fleetname]	= $ai[fleetname];
			$attack[$i][id]		= $ai[owner_id];

			$attack[$i][infinitys]	= $ai[infinitys];
			$attack[$i][wraiths]	= $ai[wraiths];
			$attack[$i][warfrigs]	= $ai[warfrigs];
			$attack[$i][cobras]	= $ai[cobras];
			$attack[$i][astropods]	= $ai[astropods];		// Getallen van de aanvallers apart
			$attack[$i][destroyers]	= $ai[destroyers];
			$attack[$i][scorpions]	= $ai[scorpions];
			$attack[$i][antennas]	= $ai[antennas];

			$infinitys		+= $ai[infinitys];
			$wraiths		+= $ai[wraiths];
			$warfrigs		+= $ai[warfrigs];
			$astropods		+= $ai[astropods];
			$cobras			+= $ai[cobras];
			$destroyers		+= $ai[destroyers];	// Getallen van de gehele aanvallende vloot samen
			$scorpions		+= $ai[scorpions];
			$antennas		+= $ai[antennas];

			$i++;
		}

		$i = 0;
		while ($attack[$i][id] > 0)
		{
			if ($infinitys>0)		$attack[$i][p_infinitys] = $attack[$i][infinitys] / $infinitys;
			else				$attack[$i][p_infinitys] = 1;

			if ($wraiths>0)			$attack[$i][p_wraiths] = $attack[$i][wraiths] / $wraiths;
			else				$attack[$i][p_wraiths] = 1;

			if ($warfrigs>0)		$attack[$i][p_warfrigs] = $attack[$i][warfrigs] / $warfrigs;
			else				$attack[$i][p_warfrigs] = 1;

			if ($astropods>0)		$attack[$i][p_astropods] = $attack[$i][astropods] / $astropods;
			else				$attack[$i][p_astropods] = 1;

			if ($destroyers>0)		$attack[$i][p_destroyers] = $attack[$i][destroyers] / $destroyers;
			else				$attack[$i][p_destroyers] = 1;

			if ($cobras>0)			$attack[$i][p_cobras] = $attack[$i][cobras] / $cobras;
			else				$attack[$i][p_cobras] = 1;

			if ($scorpions>0)		$attack[$i][p_scorpions] = $attack[$i][scorpions] / $scorpions;
			else				$attack[$i][p_scorpions] = 1;

			if ($antennas>0)		$attack[$i][p_antennas] = $attack[$i][antennas] / $antennas;
			else				$attack[$i][p_antennas] = 1;

			$i++;
		}


	# Prepare defending fleets

		$defenders_fleets = mysql_query("SELECT * FROM $TABLE[fleets] WHERE fleetname!='base' AND purpose='' AND owner_id='$id'");
		while ($fleetinfo = mysql_fetch_assoc($defenders_fleets))
		{
			if (!$fleetinfo[purpose] && !$fleetinfo[eta])
			{	// FLEET is thuis, dus verdedigt mee!
				mysql_query("UPDATE $TABLE[fleets] SET infinitys=infinitys+$fleetinfo[infinitys],wraiths=wraiths+$fleetinfo[wraiths],warfrigs=warfrigs+$fleetinfo[warfrigs],astropods=astropods+$fleetinfo[astropods],cobras=cobras+$fleetinfo[cobras],destroyers=destroyers+$fleetinfo[destroyers],scorpions=scorpions+$fleetinfo[scorpions],antennas=antennas+$fleetinfo[antennas] WHERE owner_id='$id' AND fleetname='base'");
				mysql_query("UPDATE $TABLE[fleets] SET infinitys=0,wraiths=0,warfrigs=0,astropods=0,cobras=0,destroyers=0,scorpions=0,antennas=0 WHERE id='$fleetinfo[id]'");
			}
		}

		$i=0;
		$defend = Array();
		$defenders_fleets = mysql_query("SELECT * FROM $TABLE[fleets] WHERE (fleetname='base' AND owner_id='$id') OR (fleetname!='base' AND purpose='defend' AND destination_id='$id')");
		while ($defender = mysql_fetch_assoc($defenders_fleets))
		{
			$defend[$i][fleetname]	= $defender[fleetname];
			$defend[$i][id]		= $defender[owner_id];

			$defend[$i][infinitys]	= $defender[infinitys];
			$defend[$i][wraiths]	= $defender[wraiths];
			$defend[$i][warfrigs]	= $defender[warfrigs];
			$defend[$i][astropods]	= $defender[astropods];		// Vloot per verdediger
			$defend[$i][cobras]	= $defender[cobras];
			$defend[$i][destroyers]	= $defender[destroyers];
			$defend[$i][scorpions]	= $defender[scorpions];
			$defend[$i][antennas]	= $defender[antennas];

			$d_infinitys		+= $defender[infinitys];
			$d_wraiths		+= $defender[wraiths];
			$d_warfrigs		+= $defender[warfrigs];
			$d_astropods		+= $defender[astropods];	// Totale verdedigende vloot
			$d_cobras		+= $defender[cobras];
			$d_destroyers		+= $defender[destroyers];
			$d_scorpions		+= $defender[scorpions];
			$d_antennas		+= $defender[antennas];
		}


/*
		if (!$myrow[war] && !$myrow[def])	// Vloot van de hoofdverdediger is thuis:
		{
			$defend[0][id]			= $myrow[id];
			$defend[0][infinitys]		= $myrow[infinitys_fleet]	+ $myrow[infinitys_base];
			$defend[0][wraiths]		= $myrow[wraiths_fleet]		+ $myrow[wraiths_base];
			$defend[0][warfrigs]		= $myrow[warfrigs_fleet]	+ $myrow[warfrigs_base];
			$defend[0][destroyers]		= $myrow[destroyers_fleet]	+ $myrow[destroyers_base];	// Getallen van de hoofdverdediger
			$defend[0][cobras]		= $myrow[cobras_fleet]		+ $myrow[cobras_base];
			$defend[0][scorpions]		= $myrow[scorpions_fleet]	+ $myrow[scorpions_base];
			$defend[0][astropods]		= $myrow[astropods_fleet]	+ $myrow[astropods_base];
			$defend[0][sum]			= $myrow[infinitys_fleet]	+ $myrow[infinitys_base] + $myrow[wraiths_fleet] + $myrow[wraiths_base] + $myrow[warfrigs_fleet] + $myrow[warfrigs_base] + $myrow[destroyers_fleet] + $myrow[destroyers_base] + $myrow[cobras_fleet] + $myrow[cobras_base] + $myrow[scorpions_fleet] + $myrow[scorpions_base] + $myrow[astropods_fleet]+ $myrow[astropods_base];
			$d_sum = $defend[0][sum];

			$d_infinitys	= $myrow[infinitys_fleet]	+ $myrow[infinitys_base];
			$d_wraiths	= $myrow[wraiths_fleet]		+ $myrow[wraiths_base];
			$d_warfrigs	= $myrow[warfrigs_fleet]	+ $myrow[warfrigs_base];
			$d_destroyers	= $myrow[destroyers_fleet]	+ $myrow[destroyers_base];	// Totale verdedigende vloot
			$d_cobras	= $myrow[cobras_fleet]		+ $myrow[cobras_base];
			$d_scorpions	= $myrow[scorpions_fleet]	+ $myrow[scorpions_base];
			$d_astropods	= $myrow[astropods_fleet]	+ $myrow[astropods_base];
			$d_rcannons	= $myrow[rcannons];
			$d_avengers	= $myrow[avengers];
			$d_lstalkers	= $myrow[lstalkers];
		}
		else
		{
			$defend[0][id]		= $myrow[id];
			$defend[0][infinitys]	= $myrow[infinitys_base];
			$defend[0][wraiths]	= $myrow[wraiths_base];
			$defend[0][warfrigs]	= $myrow[warfrigs_base];
			$defend[0][destroyers]	= $myrow[destroyers_base];		// Getallen van de hoofdverdediger (alleen schepen in base)
			$defend[0][cobras]	= $myrow[cobras_base];
			$defend[0][scorpions]	= $myrow[scorpions_base];
			$defend[0][astropods]	= $myrow[astropods_base];
			$defend[0][sum]		= 0;
			$d_sum = 0;

			$d_infinitys	= $myrow[infinitys_base];
			$d_wraiths	= $myrow[wraiths_base];
			$d_warfrigs	= $myrow[warfrigs_base];
			$d_destroyers	= $myrow[destroyers_base];
			$d_cobras	= $myrow[cobras_base];
			$d_scorpions	= $myrow[scorpions_base];			// Totale verdediging (zonder schepen in vloot van hoofdverdediger)
			$d_astropods	= $myrow[astropods_base];
			$d_rcannons	= $myrow[rcannons];
			$d_avengers	= $myrow[avengers];
			$d_lstalkers	= $myrow[lstalkers];
		}

		$i = 1;
		$result2 = mysql_query("SELECT * FROM $TABLE[users] WHERE def='$id' AND wareta<=10") or die("error_FB".mysql_error());
		while($myrow2=mysql_fetch_array($result2))	// Andere verdedigers
		{
			$defend[$i][id]		= $myrow2[id];
			$defend[$i][infinitys]	= $myrow2[infinitys_fleet];
			$defend[$i][wraiths]	= $myrow2[wraiths_fleet];
			$defend[$i][warfrigs]	= $myrow2[warfrigs_fleet];
			$defend[$i][destroyers]	= $myrow2[destroyers_fleet];		// Vloot van de rest van de verdedigers apart
			$defend[$i][cobras]	= $myrow2[cobras_fleet];
			$defend[$i][scorpions]	= $myrow2[scorpions_fleet];
			$defend[$i][astropods]	= $myrow2[astropods_fleet];
			$defend[$i][sum]	= $myrow[infinitys_fleet] + $myrow[wraiths_fleet] + $myrow[warfrigs_fleet] + $myrow[destroyers_fleet] + $myrow[cobras_fleet] + $myrow[scorpions_fleet] + $myrow[astropods_fleet];
			$d_sum += $defend[$i][sum];

			$d_infinitys		+= $myrow2[infinitys_fleet];
			$d_wraiths		+= $myrow2[wraiths_fleet];
			$d_warfrigs		+= $myrow2[warfrigs_fleet];
			$d_destroyers		+= $myrow2[destroyers_fleet];		// Totale verdediging (hoofdverdediger + restverdedigers)
			$d_cobras		+= $myrow2[cobras_fleet];
			$d_scorpions		+= $myrow2[scorpions_fleet];
			$d_astropods		+= $myrow2[astropods_fleet];

			$i++;
		}
*/

		$i = 0;
		while($defend[$i][id]>0)
		{
			if ($d_infinitys>0)	$defend[$i][p_infinitys] = $defend[$i][infinitys] / $d_infinitys;
			else			$defend[$i][p_infinitys] = 1;

			if ($d_wraiths>0)	$defend[$i][p_wraiths] = $defend[$i][wraiths] / $d_wraiths;
			else			$defend[$i][p_wraiths] = 1;

			if ($d_warfrigs>0)	$defend[$i][p_warfrigs] = $defend[$i][warfrigs] / $d_warfrigs;
			else			$defend[$i][p_warfrigs] = 1;

			if ($d_destroyers>0)	$defend[$i][p_destroyers] = $defend[$i][destroyers] / $d_destroyers;
			else			$defend[$i][p_destroyers] = 1;

			if ($d_cobras>0)	$defend[$i][p_cobras] = $defend[$i][cobras] / $d_cobras;
			else			$defend[$i][p_cobras] = 1;

			if ($d_scorpions>0)	$defend[$i][p_scorpions] = $defend[$i][scorpions] / $d_scorpions;
			else			$defend[$i][p_scorpions] = 1;

			if ($d_astropods>0)	$defend[$i][p_astropods] = $defend[$i][astropods] / $d_astropods;
			else			$defend[$i][p_astropods] = 1;

			if ($d_sum>0)		$defend[$i][p_sum] = $defend[$i][sum] / $d_sum;
			else			$defend[$i][p_sum] = 1;

			$i++;
		}

		// Asteroids van hoofdverdediger
		$d_crystalroid	= $myrow[asteroid_crystal];
		$d_metalroid	= $myrow[asteroid_metal];
		$d_asteroid_ui	= $myrow[asteroid_ui];

		$d_crystalroid2	= $myrow[asteroid_crystal];
		$d_metalroid2	= $myrow[asteroid_metal];
		$d_asteroid_ui2	= $myrow[asteroid_ui];


		// Aanvallende schepen
		$infinitys2	= $infinitys;
		$wraiths2	= $wraiths;
		$warfrigs2	= $warfrigs;
		$cobras2	= $cobras;
		$destroyers2	= $destroyers;
		$astropods2	= $astropods;
		$scorpions2	= $scorpions;
		$antennas2	= $antennas;


		// Verdedigende schepen
		$d_infinitys2 = $d_infinitys;
		$d_wraiths2 = $d_wraiths;
		$d_warfrigs2 = $d_warfrigs;
		$d_cobras2 = $d_cobras;
		$d_destroyers2 = $d_destroyers;
		$d_astropods2 = $d_astropods;
		$d_scorpions2 = $d_scorpions;
		$d_antennas2 = $d_antennas;
		$d_rcannons2 = $d_rcannons;
		$d_avengers2 = $d_avengers;
		$d_lstalkers2 = $d_lstalkers;


	# Ship statistics, $stats[inf][wra] = 0.01; sets the firepower of infinitys to 0.01 against wraiths.

	include("shipstats.php");

		# Verdedigers vallen aan
		attack('infinitys',$d_infinitys * $stats[inf][inf]);
		attack('wraiths',$d_infinitys * $stats[inf][wra]);
		attack('warfrigs',$d_infinitys * $stats[inf][war]);
		attack('astropods',$d_infinitys * $stats[inf][ast]);
		attack('cobras',$d_infinitys * $stats[inf][cob]);
		attack('destroyers',$d_infinitys * $stats[inf][des]);
		attack('scorpions',$d_infinitys * $stats[inf][sco]);
		attack('antennas',$d_infinitys * $stats[inf][ant]);

		attack('infinitys',$d_wraiths * $stats[wra][inf]);
		attack('wraiths',$d_wraiths * $stats[wra][wra]);
		attack('warfrigs',$d_wraiths * $stats[wra][war]);
		attack('astropods',$d_wraiths * $stats[wra][ast]);
		attack('cobras',$d_wraiths * $stats[wra][cob]);
		attack('destroyers',$d_wraiths * $stats[wra][des]);
		attack('scorpions',$d_wraiths * $stats[wra][sco]);
		attack('antennas',$d_wraiths * $stats[wra][ant]);

		attack('infinitys',$d_warfrigs * $stats[war][inf]);
		attack('wraiths',$d_warfrigs * $stats[war][wra]);
		attack('warfrigs',$d_warfrigs * $stats[war][war]);
		attack('astropods',$d_warfrigs * $stats[war][ast]);
		attack('cobras',$d_warfrigs * $stats[war][cob]);
		attack('destroyers',$d_warfrigs * $stats[war][des]);
		attack('scorpions',$d_warfrigs * $stats[war][sco]);
		attack('antennas',$d_warfrigs * $stats[war][ant]);

		attack('infinitys',$d_cobras * $stats[cob][inf]);
		attack('wraiths',$d_cobras * $stats[cob][wra]);
		attack('warfrigs',$d_cobras * $stats[cob][war]);
		attack('cobras',$d_cobras * $stats[cob][cob]);
		attack('destroyers',$d_cobras * $stats[cob][des]);
		attack('scorpions',$d_cobras * $stats[cob][sco]);

		attack('infinitys',$d_destroyers * $stats[des][inf]);
		attack('wraiths',$d_destroyers * $stats[des][wra]);
		attack('warfrigs',$d_destroyers * $stats[des][war]);
		attack('astropods',$d_destroyers * $stats[des][ast]);
		attack('cobras',$d_destroyers * $stats[des][cob]);
		attack('destroyers',$d_destroyers * $stats[des][des]);
		attack('scorpions',$d_destroyers * $stats[des][sco]);
		attack('antennas',$d_destroyers * $stats[des][ant]);

		attack('infinitys',$d_scorpions * $stats[sco][inf]);
		attack('wraiths',$d_scorpions * $stats[sco][wra]);
		attack('warfrigs',$d_scorpions * $stats[sco][war]);
		attack('astropods',$d_scorpions * $stats[sco][ast]);
		attack('cobras',$d_scorpions * $stats[sco][cob]);
		attack('destroyers',$d_scorpions * $stats[sco][des]);
		attack('scorpions',$d_scorpions * $stats[sco][sco]);
		attack('antennas',$d_scorpions * $stats[sco][ant]);

		attack('infinitys',$d_antennas * $stats[ant][inf]);
		attack('wraiths',$d_antennas * $stats[ant][wra]);
		attack('warfrigs',$d_antennas * $stats[ant][war]);
		attack('astropods',$d_antennas * $stats[ant][ast]);
		attack('cobras',$d_antennas * $stats[ant][cob]);
		attack('destroyers',$d_antennas * $stats[ant][des]);
		attack('scorpions',$d_antennas * $stats[ant][sco]);
		attack('antennas',$d_antennas * $stats[ant][ant]);

		attack('infinitys',$d_rcannons * $stats[rca][inf]);
		attack('astropods',$d_rcannons * $stats[rca][ast]);
		attack('antennas',$d_rcannons * $stats[rca][ant]);

		attack('wraiths',$d_avengers * $stats[ave][wra]);
		attack('warfrigs',$d_avengers * $stats[ave][war]);
		attack('cobras',$d_avengers * $stats[ave][cob]);

		attack('destroyers',$d_lstalkers * $stats[lst][des]);
		attack('scorpions',$d_lstalkers * $stats[lst][sco]);

# ---------------------------------------------

		# Aanvallers vallen aan
		attack('d_infinitys',$infinitys2 * $stats[inf][inf]);
		attack('d_wraiths',$infinitys2 * $stats[inf][wra]);
		attack('d_warfrigs',$infinitys2 * $stats[inf][war]);
		attack('d_astropods',$infinitys2 * $stats[inf][ast]);
		attack('d_cobras',$infinitys2 * $stats[inf][cob]);
		attack('d_destroyers',$infinitys2 * $stats[inf][des]);
		attack('d_scorpions',$infinitys2 * $stats[inf][sco]);
		attack('d_antennas',$infinitys2 * $stats[inf][ant]);

		attack('d_infinitys',$wraiths2 * $stats[wra][inf]);
		attack('d_wraiths',$wraiths2 * $stats[wra][wra]);
		attack('d_warfrigs',$wraiths2 * $stats[wra][war]);
		attack('d_astropods',$wraiths2 * $stats[wra][ast]);
		attack('d_cobras',$wraiths2 * $stats[wra][cob]);
		attack('d_destroyers',$wraiths2 * $stats[wra][inf]);
		attack('d_scorpions',$wraiths2 * $stats[wra][sco]);
		attack('d_antennas',$wraiths2 * $stats[wra][ant]);
		attack('d_lstalkers',$wraiths2 * $stats[wra][lst]);

		attack('d_infinitys',$warfrigs2 * $stats[war][inf]);
		attack('d_wraiths',$warfrigs2 * $stats[war][wra]);
		attack('d_warfrigs',$warfrigs2 * $stats[war][war]);
		attack('d_astropods',$warfrigs2 * $stats[war][ast]);
		attack('d_cobras',$warfrigs2 * $stats[war][cob]);
		attack('d_destroyers',$warfrigs2 * $stats[war][des]);
		attack('d_scorpions',$warfrigs2 * $stats[war][sco]);
		attack('d_antennas',$warfrigs2 * $stats[war][ant]);
		attack('d_rcannons',$warfrigs2 * $stats[war][rca]);

		attack('d_infinitys',$cobras2 * $stats[cob][inf]);
		attack('d_wraiths',$cobras2 * $stats[cob][wra]);
		attack('d_warfrigs',$cobras2 * $stats[cob][war]);
		attack('d_cobras',$cobras2 * $stats[cob][cob]);
		attack('d_destroyers',$cobras2 * $stats[cob][des]);
		attack('d_scorpions',$cobras2 * $stats[cob][sco]);
		attack('d_antennas',$cobras2 * $stats[cob][ant]);

		attack('d_infinitys',$destroyers2 * $stats[des][inf]);
		attack('d_wraiths',$destroyers2 * $stats[des][wra]);
		attack('d_warfrigs',$destroyers2 * $stats[des][war]);
		attack('d_astropods',$destroyers2 * $stats[des][ast]);
		attack('d_cobras',$destroyers2 * $stats[des][cob]);
		attack('d_destroyers',$destroyers2 * $stats[des][des]);
		attack('d_scorpions',$destroyers2 * $stats[des][sco]);
		attack('d_antennas',$destroyers2 * $stats[des][ant]);
		attack('d_avengers',$destroyers2 * $stats[des][ave]);

		attack('d_infinitys',$scorpions2 * $stats[sco][inf]);
		attack('d_wraiths',$scorpions2 * $stats[sco][wra]);
		attack('d_warfrigs',$scorpions2 * $stats[sco][war]);
		attack('d_astropods',$scorpions2 * $stats[sco][ast]);
		attack('d_cobras',$scorpions2 * $stats[sco][cob]);
		attack('d_destroyers',$scorpions2 * $stats[sco][des]);
		attack('d_scorpions',$scorpions2 * $stats[sco][sco]);
		attack('d_antennas',$scorpions2 * $stats[sco][ant]);

		attack('d_infinitys',$antennas2 * $stats[ant][inf]);
		attack('d_wraiths',$antennas2 * $stats[ant][wra]);
		attack('d_warfrigs',$antennas2 * $stats[ant][war]);
		attack('d_astropods',$antennas2 * $stats[ant][ast]);
		attack('d_cobras',$antennas2 * $stats[ant][cob]);
		attack('d_destroyers',$antennas2 * $stats[ant][des]);
		attack('d_scorpions',$antennas2 * $stats[ant][sco]);
		attack('d_antennas',$antennas2 * $stats[ant][ant]);


		// ROID-CAPTURING

		$i = 0;
		$t_block=0;
		while ($attack[$i][id]>0)
		{
			if ($d_cobras >= $attack[$i][astropods])
			{
				$block = $attack[$i][astropods];
			}
			else
			{
				$roidsc = Roids_capped($attack[$i][astropods]-$block,$d_crystalroid,$d_metalroid,$d_asteroid_ui,count($attack));
				$roidscapped = $roidsc[crystal] + $roidsc[metal] + $roidsc[ui];
				mysql_query("UPDATE $TABLE[users] SET asteroid_metal=asteroid_metal+$roidsc[metal],asteroid_crystal=asteroid_crystal+$roidsc[crystal],asteroid_ui=asteroid_ui+$roidsc[ui] WHERE id='".$attack[$i][id]."'") or die("error_FC".mysql_error()); 
				mysql_query("UPDATE $TABLE[users] SET asteroid_metal=asteroid_metal-$roidsc[metal],asteroid_crystal=asteroid_crystal-$roidsc[crystal],asteroid_ui=asteroid_ui-$roidsc[ui] WHERE id='$id'") or die("error_FD".mysql_error()); 

				$block = $d_cobras;
			}
			$t_block += $block;

			$l_infinitys	= floor(($infinitys2-$infinitys)	* $attack[$i][p_infinitys]);
			$l_wraiths	= floor(($wraiths2-$wraiths)		* $attack[$i][p_wraiths]);
			$l_warfrigs	= floor(($warfrigs2-$warfrigs)		* $attack[$i][p_warfrigs]);
			$l_astropods	= floor(($astropods2-$astropods)	* $attack[$i][p_astropods]);
			$l_cobras	= floor(($cobras2-$cobras)		* $attack[$i][p_cobras]);		// Verloren schepen PER aanvaller
			$l_destroyers	= floor(($destroyers2-$destroyers)	* $attack[$i][p_destroyers]);
			$l_scorpions	= floor(($scorpions2-$scorpions)	* $attack[$i][p_scorpions]);
			$l_antennas	= floor(($antennas2-$antennas)		* $attack[$i][p_antennas]);

			if ($attack[$i][astropods]-$l_astropods-$roidscapped<0)
			{
				$l_astropods = $attack[$i][astropods];
			}
			else
			{
				$l_astropods = $l_astropods+$roidscapped;
			}

/*
			if ($l_infinitys < 0) $l_infinitys = 0;
			if ($l_wraiths < 0) $l_wraiths = 0;
			if ($l_warfrigs < 0) $l_warfrigs = 0;
			if ($l_destroyers < 0) $l_destroyers = 0;
			if ($l_astropods < 0) $l_astropods = 0;
			if ($l_scorpions < 0) $l_scorpions = 0;
			if ($l_cobras < 0) $l_cobras = 0;

			if ($d_infinitys2 <0) $d_infinitys2 = 0;
			if ($d_wraiths2 <0) $d_wraiths2 = 0;
			if ($d_warfrigs2 <0) $d_warfrigs2 = 0;
			if ($d_destroyers2 <0) $d_destroyers2 = 0;
			if ($d_cobras2 <0) $d_cobras2 = 0;
			if ($d_astropods2 <0) $d_astropods2 = 0;
			if ($d_scorpions2 <0) $d_scorpions2 = 0;

			if ($d_infinitys <0) $d_infinitys = 0;
			if ($d_wraiths <0) $d_wraiths = 0;
			if ($d_warfrigs <0) $d_warfrigs = 0;
			if ($d_destroyers <0) $d_destroyers = 0;
			if ($d_cobras <0) $d_cobras = 0;
			if ($d_astropods <0) $d_astropods = 0;
			if ($d_scorpions <0) $d_scorpions = 0;
*/

			// Zoveel van het totaal aanvallende schepen zijn er verloren
			$inf = floor($d_infinitys2-$d_infinitys);
			if ($inf < 0) $inf = 0;
			$wra = floor($d_wraiths2-$d_wraiths);
			if ($wra < 0) $wra = 0;
			$war = floor($d_warfrigs2-$d_warfrigs);
			if ($war < 0) $war = 0;
			$ast = floor($d_astropods2-$d_astropods);
			if ($ast < 0) $ast = 0;
			$cob = floor($d_cobras2-$d_cobras);
			if ($cob < 0) $cob = 0;
			$des = $d_destroyers2-$d_destroyers;
			if ($des < 0) $des = 0;
			$sco = floor($d_scorpions2-$d_scorpions);
			if ($sco < 0) $sco = 0;
			$ant = floor($d_antennas2-$d_antennas);
			if ($ant < 0) $ant = 0;



// COMBATREPORT // voor alle aanvallers //

			AddNews("combatreport",
			"<table border=0 cellpadding=3 cellspacing=0 width=100%>
			<tr><td colspan=3>Combat At $g_rulername of $g_planetname ($g_x:$g_y)</td></tr>
			<tr><td><b>Defender(s):</td><td>Total:</td><td>Lost:</td></tr>\n
			<tr><td>Infinitys:</td><td>".nummertje($d_infinitys2)."</td><td>".nummertje($inf)."</tr>\n
			<tr><td>Wraiths:</td><td>".nummertje($d_wraiths2)."</td><td>".nummertje($wra)."</tr>\n
			<tr><td>Warfrigates:</td><td>".nummertje($d_warfrigs2)."</td><td>".nummertje($war)."</tr>\n
			<tr><td>Astropods:</td><td>".nummertje($d_astropods2)."</td><td>".nummertje($ast)."</tr>\n
			<tr><td>Cobras:</td><td>".nummertje($d_cobras2)."</td><td>".nummertje($cob)."</tr>\n
			<tr><td>Destroyers:</td><td>".nummertje($d_destroyers2)."</td><td>".nummertje($des)."</tr>\n
			<tr><td>Scorpions:</td><td>".nummertje($d_scorpions2)."</td><td>".nummertje($sco)."</tr>\n
			<tr><td>Antennas:</td><td>".nummertje($d_antennas2)."</td><td>".nummertje($ant)."</tr>\n
			<tr><td>Reaper Cannons:</td><td>".nummertje($d_rcannons2)."</td><td>".nummertje($d_rcannons2-$d_rcannons)."</tr>\n
			<tr><td>Avengers:</td><td>".nummertje($d_avengers2)."</td><td>".nummertje($d_avengers2-$d_avengers)."</tr>\n
			<tr><td>Lucius Stalkers:</td><td>".nummertje($d_lstalkers2)."</td><td>".nummertje($d_lstalkers2-$d_lstalkers)."</tr>\n
			<tr><td colspan=3><b>Attacker(s):</td></tr>\n
			<tr><td>Infinitys:</td><td>".nummertje($infinitys2)."</td><td>".nummertje($infinitys2-$infinitys)."</tr>\n
			<tr><td>Wraiths:</td><td>".nummertje($wraiths2)."</td><td>".nummertje($wraiths2-$wraiths)."</tr>\n
			<tr><td>Warfrigates:</td><td>".nummertje($warfrigs2)."</td><td>".nummertje($warfrigs2-$warfrigs)."</tr>\n
			<tr><td>Astropods:</td><td>".nummertje($astropods2)." (".nummertje($block)." blocked)</td><td>".nummertje($astropods2-$astropods)."</tr>\n
			<tr><td>Cobras:</td><td>".nummertje($cobras2)."</td><td>".nummertje($cobras2-$cobras)."</tr>\n
			<tr><td>Destroyers:</td><td>".nummertje($destroyers2)."</td><td>".nummertje($destroyers2-$destroyers)."</tr>\n
			<tr><td>Scorpions:</td><td>".nummertje($scorpions2)."</td><td>".nummertje($scorpions2-$scorpions)."</tr>\n
			<tr><td>Antennas:</td><td>".nummertje($antennas2)."</td><td>".nummertje($antennas2-$antennas)."</tr>\n
			<tr><td colspan=3><b>Yours (=attacker):</td></tr>\n
			<tr><td>Infinitys:</td><td>".nummertje($attack[$i][infinitys])."</td><td>".nummertje($l_infinitys)."</tr>\n
			<tr><td>Wraiths:</td><td>".nummertje($attack[$i][wraiths])."</td><td>".nummertje($l_wraiths)."</tr>\n
			<tr><td>Warfrigates:</td><td>".nummertje($attack[$i][warfrigs])."</td><td>".nummertje($l_warfrigs)."</tr>\n
			<tr><td>Astropods:</td><td>".nummertje($attack[$i][astropods])." (".nummertje($block)." blocked)</td><td>".nummertje($l_astropods)."</tr>\n
			<tr><td>Cobras:</td><td>".nummertje($attack[$i][cobras])."</td><td>".nummertje($l_cobras)."</tr>\n
			<tr><td>Destroyers:</td><td>".nummertje($attack[$i][destroyers])."</td><td>".nummertje($l_destroyers)."</tr>\n
			<tr><td>Scorpions:</td><td>".nummertje($attack[$i][scorpions])."</td><td>".nummertje($l_scorpions)."</tr>\n
			<tr><td>Antennas:</td><td>".nummertje($attack[$i][antennas])."</td><td>".nummertje($l_antennas)."</tr>\n
			<tr><td colspan=3><b>Roids captured:</td></tr>\n
			<tr><td>Metal:</td><td colspan=2>$roidsc[metal] / $d_metalroid</td></tr>\n
			<tr><td>Crystal:</td><td colspan=2>$roidsc[crystal] / $d_crystalroid</td></tr>\n
			<tr><td>Undeveloped:</td><td colspan=2>$roidsc[ui] / $d_asteroid_ui</td></tr>\n
			</table>\n",$attack[$i][id]);

			mysql_query("UPDATE $TABLE[fleets] SET infinitys=infinitys-$l_infinitys, wraiths=wraiths-$l_wraiths, warfrigs=warfrigs-$l_warfrigs, cobras=cobras-$l_cobras, destroyers=destroyers-$l_destroyers, astropods=astropods-$l_astropods, scorpion=scorpions-$l_scorpions, antennas=antennas-$l_antennas,actiontime=actiontime-1 WHERE owner_id='".$attack[$i][id]."' AND fleetname='".$attack[$i][fleetname]."' AND purpose='attack'");

			$i++;

			$d_crystalroid -= $roidsc[crystal];
			$d_metalroid -= $roidsc[metal];
			$d_asteroid_ui -= $roidsc[ui];
		}

/*
		//
		# Primary defender calcs
		# ----------------------
		//
		$i = 0;

		$l_infinitys = floor(round($d_infinitys2-$d_infinitys) * $defend[$i][p_infinitys]);
		$l_wraiths = floor(round($d_wraiths2-$d_wraiths) * $defend[$i][p_wraiths]);
		$l_warfrigs = floor(round($d_warfrigs2-$d_warfrigs) * $defend[$i][p_warfrigs]);
		$l_destroyers = floor(round($d_destroyers2-$d_destroyers) * $defend[$i][p_destroyers]);
		$l_astropods = floor(round($d_astropods2-$d_astropods) * $defend[$i][p_astropods]);
		$l_scorpions = floor(round($d_scorpions2-$d_scorpions) * $defend[$i][p_scorpions]);
		$l_cobras = floor(round($d_cobras2-$d_cobras) * $defend[$i][p_cobras]);
		$l_rcannons = floor($d_rcannons2-$d_rcannons);
		$l_avengers = floor($d_avengers2-$d_avengers);
		$l_lstalkers = floor($d_lstalkers2-$d_lstalkers);

		if ($l_infinitys < 0) $l_infinitys = 0;
		if ($l_wraiths < 0) $l_wraiths = 0;
		if ($l_warfrigs < 0) $l_warfrigs = 0;
		if ($l_destroyers < 0) $l_destroyers = 0;
		if ($l_astropods < 0) $l_astropods = 0;
		if ($l_scorpions < 0) $l_scorpions = 0;
		if ($l_cobras < 0) $l_cobras = 0;

		if ($d_infinitys2 <0) $d_infinitys2 = 0;
		if ($d_wraiths2 <0) $d_wraiths2 = 0;
		if ($d_warfrigs2 <0) $d_warfrigs2 = 0;
		if ($d_destroyers2 <0) $d_destroyers2 = 0;
		if ($d_cobras2 <0) $d_cobras2 = 0;
		if ($d_astropods2 <0) $d_astropods2 = 0;
		if ($d_scorpions2 <0) $d_scorpions2 = 0;

		if ($d_infinitys <0) $d_infinitys = 0;
		if ($d_wraiths <0) $d_wraiths = 0;
		if ($d_warfrigs <0) $d_warfrigs = 0;
		if ($d_destroyers <0) $d_destroyers = 0;
		if ($d_cobras <0) $d_cobras = 0;
		if ($d_astropods <0) $d_astropods = 0;
		if ($d_scorpions <0) $d_scorpions = 0;

		$inf = round($d_infinitys2-$d_infinitys);
		if ($inf < 0) $inf = 0;
		$wra = round($d_wraiths2-$d_wraiths);
		if ($wra < 0) $wra = 0;
		$war = round($d_warfrigs2-$d_warfrigs);
		if ($war < 0) $war = 0;
		$des = $d_destroyers2-$d_destroyers;
		if ($des < 0) $des = 0;
		$ast = round($d_astropods2-$d_astropods);
		if ($ast < 0) $ast = 0;
		$sco = round($d_scorpions2-$d_scorpions);
		if ($sco < 0) $sco = 0;
		$cob = round($d_cobras2-$d_cobras);
		if ($cob < 0) $cob = 0;



// COMBATREPORT // verdediging (target) //

		AddNews("combatreport",
		"<table border=0 cellpadding=3 cellspacing=0 width=100%>
		<tr><td colspan=3>Combat found place at $username #$id</td></tr>
		<tr><td><b>Defender(s):</td><td>Total:</td><td>Lost:</td></tr>\n
		<tr><td>Infinitys:</td><td>".nummertje($d_infinitys2)."</td><td>".nummertje($d_infinitys2-$d_infinitys)."</tr>\n
		<tr><td>Wraiths:</td><td>".nummertje($d_wraiths2)."</td><td>".nummertje($d_wraiths2-$d_wraiths)."</tr>\n
		<tr><td>Warfrigates:</td><td>".nummertje($d_warfrigs2)."</td><td>".nummertje($d_warfrigs2-$d_warfrigs)."</tr>\n
		<tr><td>Astropods:</td><td>".nummertje($d_astropods2)."</td><td>".nummertje($d_astropods2-$d_astropods)."</tr>\n
		<tr><td>Cobras:</td><td>".nummertje($d_cobras2)."</td><td>".nummertje($d_cobras2-$d_cobras)."</tr>\n
		<tr><td>Destroyers:</td><td>".nummertje($d_destroyers2)."</td><td>".nummertje($d_destroyers2-$d_destroyers)."</tr>\n
		<tr><td>Scorpions:</td><td>".nummertje($d_scorpions2)."</td><td>".nummertje($d_scorpions2-$d_scorpions)."</tr>\n
		<tr><td colspan=3><b>Attacker(s):</td></tr>\n
		<tr><td>Infinitys:</td><td>".nummertje($infinitys2)."</td><td>".nummertje($infinitys2-$infinitys_fleet)."</tr>\n
		<tr><td>Wraiths:</td><td>".nummertje($wraiths2)."</td><td>".nummertje($wraiths2-$wraiths_fleet)."</tr>\n
		<tr><td>Warfrigates:</td><td>".nummertje($warfrigs2)."</td><td>".nummertje($warfrigs2-$warfrigs_fleet)."</tr>\n
		<tr><td>Astropods:</td><td>".nummertje($astropods2)." (".nummertje($t_block)." blocked)</td><td>".nummertje($astropods2-$astropods_fleet)."</tr>\n
		<tr><td>Cobras:</td><td>".nummertje($cobras2)."</td><td>".nummertje($cobras2-$cobrass_fleet)."</tr>\n
		<tr><td>Destroyers:</td><td>".nummertje($destroyers2)."</td><td>".nummertje($destroyers2-$destroyers_fleet)."</tr>\n
		<tr><td>Scorpions:</td><td>".nummertje($scorpions2)."</td><td>".nummertje($scorpions2-$scorpions_fleet)."</tr>\n
		<tr><td colspan=3><b>Yours (=THEdefender):</td></tr>\n
		<tr><td>Infinitys:</td><td>".nummertje($defend[$i][infinitys])."</td><td>".nummertje($l_infinitys)."</tr>\n
		<tr><td>Wraiths:</td><td>".nummertje($defend[$i][wraiths])."</td><td>".nummertje($l_wraiths)."</tr>\n
		<tr><td>Warfrigates:</td><td>".nummertje($defend[$i][warfrigs])."</td><td>".nummertje($l_warfrigs)."</tr>\n
		<tr><td>Astropods:</td><td>".nummertje($defend[$i][astropods])."</td><td>".nummertje($l_astropods)."</tr>\n
		<tr><td>Cobras:</td><td>".nummertje($defend[$i][cobras])."</td><td>".nummertje($l_cobras)."</tr>\n
		<tr><td>Destroyers:</td><td>".nummertje($defend[$i][destroyers])."</td><td>".nummertje($l_destroyers)."</tr>\n
		<tr><td>Scorpions:</td><td>".nummertje($defend[$i][scorpions])."</td><td>".nummertje($l_scorpions)."</tr>\n
		<tr><td>Reaper cannons:</td><td>".nummertje($d_rcannons2)."</td><td>".nummertje($d_rcannons2-$d_rcannons)."</tr>\n
		<tr><td>Avengers:</td><td>".nummertje($d_avengers2)."</td><td>".nummertje($d_avengers2-$d_avengers)."</tr>\n
		<tr><td>Lucius stalkers:</td><td>".nummertje($d_lstalkers2)."</td><td>".nummertje($d_lstalkers2-$d_lstalkers)."</tr>\n
		<tr><td colspan=3><b>Roids lost:</td></tr>
		<tr><td>Metal:</td><td colspan=2>".($d_metalroid2-$d_metalroid)." / $d_metalroid2</td></tr>
		<tr><td>Crystal:</td><td colspan=2>".($d_crystalroid2-$d_crystalroid)." / $d_crystalroid2</td></tr>
		<tr><td>Undeveloped:</td><td colspan=2>".($d_asteroid_ui2-$d_asteroid_ui)." / $d_asteroid_ui2</td></tr>
		</table>\n",$defend[$i][id]);




		mysql_query("UPDATE $TABLE[users] SET infinitys_fleet=infinitys_fleet-$l_infinitys,wraiths_fleet=wraiths_fleet-$l_wraiths,warfrigs_fleet=warfrigs_fleet-$l_warfrigs,destroyers_fleet=destroyers_fleet-$l_destroyers,astropods_fleet=astropods_fleet-$l_astropods,scorpions_fleet=scorpions_fleet-$l_scorpions,cobras_fleet=cobras_fleet-$l_cobras,rcannons=rcannons-$l_rcannons,avengers=avengers-$l_avengers,lstalkers=lstalkers-$l_lstalkers WHERE id=".$defend[$i]["id"]);

		mysql_query("UPDATE $TABLE[users] SET infinitys_base=infinitys_base-$inf,wraiths_base=wraiths_base-$wra,warfrigs_base=warfrigs_base-$war,destroyers_base=destroyers_base-$des,astropods_base=astropods_base-$ast,scorpions_base=scorpions_base-$sco,cobras_base=cobras_base-$cob WHERE id=".$defend[0]["id"]);

		mysql_query("UPDATE $TABLE[users] SET infinitys_base=0,wraiths_base=0,warfrigs_base=0,destroyers_base=0,astropods_base=0,scorpions_base=0,cobras_base=0 WHERE infinitys_base < 0 AND wraiths_base < 0 AND warfrigates_base < 0 AND astropods_base < 0 AND cobras < 0 AND scorpions_base < 0 AND id=".$defend[$i]["id"]);

		mysql_query("UPDATE $TABLE[users] SET infinitys_fleet=0 where infinitys_fleet < 0 AND id=".$defend[$i]["id"]);
		mysql_query("UPDATE $TABLE[users] SET infinitys_base=0 where infinitys_base < 0 AND id=".$defend[$i]["id"]);

		mysql_query("UPDATE $TABLE[users] SET cobras_fleet=0 where cobras_fleet < 0 AND id=".$defend[$i]["id"]);
		mysql_query("UPDATE $TABLE[users] SET cobras_base=0 where cobras_base < 0 AND id=".$defend[$i]["id"]);

		mysql_query("UPDATE $TABLE[users] SET wraiths_fleet=0 where wraiths_fleet < 0 AND id=".$defend[$i]["id"]);
		mysql_query("UPDATE $TABLE[users] SET wraiths_base=0 where wraiths_base < 0 AND id=".$defend[$i]["id"]);

		mysql_query("UPDATE $TABLE[users] SET warfrigs_fleet=0 where warfrigs_fleet < 0 AND id=".$defend[$i]["id"]);
		mysql_query("UPDATE $TABLE[users] SET warfrigs_base=0 where warfrigs_base < 0 AND id=".$defend[$i]["id"]);

		mysql_query("UPDATE $TABLE[users] SET destroyers_fleet=0 where destroyers_fleet < 0 AND id=".$defend[$i]["id"]);
		mysql_query("UPDATE $TABLE[users] SET destroyers_base=0 where destroyers_base < 0 AND id=".$defend[$i]["id"]);

		mysql_query("UPDATE $TABLE[users] SET scorpions_fleet=0 where scorpions_fleet < 0 AND id=".$defend[$i]["id"]);
		mysql_query("UPDATE $TABLE[users] SET scorpions_base=0 where scorpions_base < 0 AND id=".$defend[$i]["id"]);

		mysql_query("UPDATE $TABLE[users] SET astropods_fleet=0 where astropods_fleet < 0 AND id=".$defend[$i]["id"]);
		mysql_query("UPDATE $TABLE[users] SET astropods_base=0 where astropods_base < 0 AND id=".$defend[$i]["id"]);

		$i++;


		// END PRIMARY-DEFENDER CALCS
*/


		while ($defend[$i][id]>=0)
		{
			$l_infinitys = floor(round($d_infinitys2-$d_infinitys) * $defend[$i][p_infinitys]);
			$l_wraiths = floor(round($d_wraiths2-$d_wraiths) * $defend[$i][p_wraiths]);
			$l_warfrigs = floor(round($d_warfrigs2-$d_warfrigs) * $defend[$i][p_warfrigs]);
			$l_destroyers = floor(round($d_destroyers2-$d_destroyers) * $defend[$i][p_destroyers]);
			$l_astropods = floor(round($d_astropods2-$d_astropods) * $defend[$i][p_astropods]);
			$l_scorpions = floor(round($d_scorpions2-$d_scorpions) * $defend[$i][p_scorpions]);
			$l_cobras = floor(round($d_cobras2-$d_cobras) * $defend[$i][p_cobras]);

/*
			if ($l_infinitys < 0) $l_infinitys = 0;
			if ($l_wraiths < 0) $l_wraiths = 0;
			if ($l_warfrigs < 0) $l_warfrigs = 0;
			if ($l_destroyers < 0) $l_destroyers = 0;
			if ($l_astropods < 0) $l_astropods = 0;
			if ($l_scorpions < 0) $l_scorpions = 0;
			if ($l_cobras < 0) $l_cobras = 0;

			if ($d_infinitys2 <0) $d_infinitys2 = 0;
			if ($d_wraiths2 <0) $d_wraiths2 = 0;
			if ($d_warfrigs2 <0) $d_warfrigs2 = 0;
			if ($d_destroyers2 <0) $d_destroyers2 = 0;
			if ($d_cobras2 <0) $d_cobras2 = 0;
			if ($d_astropods2 <0) $d_astropods2 = 0;
			if ($d_scorpions2 <0) $d_scorpions2 = 0;

			if ($d_infinitys <0) $d_infinitys = 0;
			if ($d_wraiths <0) $d_wraiths = 0;
			if ($d_warfrigs <0) $d_warfrigs = 0;
			if ($d_destroyers <0) $d_destroyers = 0;
			if ($d_cobras <0) $d_cobras = 0;
			if ($d_astropods <0) $d_astropods = 0;
			if ($d_scorpions <0) $d_scorpions = 0;
*/

			$inf = round($d_infinitys2-$d_infinitys);
			if ($d_infinitys2-$d_infinitys < 0) $a = 0;
			$wra = round($d_wraiths2-$d_wraiths);
			if ($wra < 0) $wra = 0;
			$war = round($d_warfrigs2-$d_warfrigs);
			if ($war < 0) $war = 0;
			$des = $d_destroyers2-$d_destroyers;
			if ($des < 0) $des = 0;
			$ast = round($d_astropods2-$d_astropods);
			if ($ast < 0) $ast = 0;
			$sco = round($d_scorpions2-$d_scorpions);
			if ($sco < 0) $sco = 0;
			$cob = round($d_cobras2-$d_cobras);
			if ($cob < 0) $cob = 0;



		// COMBATREPORT // Alle Verdedigers //

			AddNews("combatreport",
			"<table border=0 cellpadding=3 cellspacing=0 width=100%>
			<tr><td colspan=3>Combat At $g_rulername of $g_planetname ($g_x:$g_y)</td></tr>
			<tr><td><b>Defender(s):</td><td>Total:</td><td>Lost:</td></tr>
			<tr><td>Infinitys:</td><td>".nummertje($d_infinitys2)."</td><td>".(number_format($d_infinitys2-$d_infinitys))."</tr>
			<tr><td>Wraiths:</td><td>".nummertje($d_wraiths2)."</td><td>".(nummertje($d_wraiths2-$d_wraiths))."</tr>
			<tr><td>Warfrigates:</td><td>".nummertje($d_warfrigs2)."</td><td>".(nummertje($d_warfrigs2-$d_warfrigs))."</tr>
			<tr><td>Astropods:</td><td>".nummertje($d_astropods2)."</td><td>".(nummertje($d_astropods2-$d_astropods))."</tr>
			<tr><td>Cobras:</td><td>".nummertje($d_cobras2)."</td><td>".(nummertje($d_cobras2-$d_cobras))."</tr>
			<tr><td>Destroyers:</td><td>".nummertje($d_destroyers2)."</td><td>".(nummertje($d_destroyers2-$d_destroyers))."</tr>
			<tr><td>Scorpions:</td><td>".nummertje($d_scorpions2)."</td><td>".(nummertje($d_scorpions2-$d_scorpions))."</tr>
			<tr><td>Antennas:</td><td>".nummertje($d_antennas2)."</td><td>".(nummertje($d_antennas2-$d_antennas))."</tr>
			<tr><td colspan=3><b>Attacker(s):</td></tr>
			<tr><td>Infinitys:</td><td>".nummertje($infinitys2)."</td><td>".(nummertje($infinitys2-$infinitys))."</tr>
			<tr><td>Wraiths:</td><td>".nummertje($wraiths2)."</td><td>".(nummertje($wraiths2-$wraiths))."</tr>
			<tr><td>Warfrigates:</td><td>".nummertje($warfrigs2)."</td><td>".(nummertje($warfrigs2-$warfrigs))."</tr>
			<tr><td>Astropods:</td><td>".nummertje($astropods2)." (".nummertje($t_block)." blocked)</td><td>".(nummertje($astropods2-$astropods))."</tr>
			<tr><td>Cobras:</td><td>".nummertje($cobras2)."</td><td>".(nummertje($cobras2-$cobras))."</tr>
			<tr><td>Destroyers:</td><td>".nummertje($destroyers2)."</td><td>".(nummertje($destroyers2-$destroyers))."</tr>
			<tr><td>Scorpions:</td><td>".nummertje($scorpions2)."</td><td>".(nummertje($scorpions2-$scorpions))."</tr>
			<tr><td>Antennas:</td><td>".nummertje($antennas2)."</td><td>".(nummertje($antennas2-$antennas))."</tr>
			<tr><td colspan=3><b>Yours:</td></tr>
			<tr><td>Infinitys:</td><td>".nummertje($defend[$i][infinitys])."</td><td>".nummertje($l_infinitys)."</tr>
			<tr><td>Wraiths:</td><td>".nummertje($defend[$i][wraiths])."</td><td>".nummertje($l_wraiths)."</tr>
			<tr><td>Warfrigates:</td><td>".nummertje($defend[$i][warfrigs])."</td><td>".nummertje($l_warfrigs)."</tr>
			<tr><td>Astropods:</td><td>".nummertje($defend[$i][astropods])."</td><td>".nummertje($l_astropods)."</tr>
			<tr><td>Cobras:</td><td>".nummertje($defend[$i][cobras])."</td><td>".nummertje($l_cobras)."</tr>
			<tr><td>Destroyers:</td><td>".nummertje($defend[$i][destroyers])."</td><td>".nummertje($l_destroyers)."</tr>
			<tr><td>Scorpions:</td><td>".nummertje($defend[$i][scorpions])."</td><td>".nummertje($l_scorpions)."</tr>
			<tr><td>Antennas:</td><td>".nummertje($defend[$i][antennas])."</td><td>".nummertje($l_antennas)."</tr>
			<tr><td>Reaper Cannons:</td><td>".nummertje($d_rcannons2)."</td><td>".(nummertje($d_rcannons2-$d_rcannons))."</tr>
			<tr><td>Avengers:</td><td>".nummertje($d_avengers2)."</td><td>".(nummertje($d_avengers2-$d_avengers))."</tr>
			<tr><td>Lucius Stalkers:</td><td>".nummertje($d_lstalkers2)."</td><td>".(nummertje($d_lstalkers2-$d_lstalkers))."</tr>
			<tr><td><b>Roids Lost:</td></tr>
			<tr><td>Metal:</td><td>".($d_metalroid2-$d_metalroid)."/$d_metalroid</td></tr>
			<tr><td>Crystal:</td><td>".($d_crystalroid2-$d_crystalroid)."/$d_crystalroid</td></tr>
			<tr><td>Undeveloped:</td><td>".($d_asteroid_ui2-$d_asteroid_ui)."/$d_asteroid_ui</td></tr>
			</table>\n",$defend[$i][id]);

			
			mysql_query("UPDATE $TABLE[fleet] SET infinitys=infinitys-$l_infinitys, wraiths=wraiths-$l_wraiths, warfrigs=warfrigs-$l_warfrigs, astropods=astropods-$l_astropods, cobras=cobras-$l_cobras, destroyers=destroyers-$l_destroyers, scorpions=scorpions-$l_scorpions, antennas=antennas-$l_antennas WHERE owner_id='".$defend[$i][id]."' AND fleetname='".$defend[$i][fleetname]."' AND purpose='defend'"); 
			if ($i>0)
				mysql_query("UPDATE $TABLE[fleets] SET actiontime=actiontime-1 WHERE owner_id='".$defend[$i][id]."' AND fleetname='".$defend[$i][fleetname]."' AND purpose='defend'");

			$i++;
		}
	}
	// Fleet check
	mysql_query("UPDATE $TABLE[fleets] SET owner_x='$myrow[x]', owner_y='$myrow[y]' WHERE owner_id='$myrow[id]'");
}

mysql_query("UPDATE $TABLE[fleets] SET infinitys=0 WHERE infinitys<0");
mysql_query("UPDATE $TABLE[fleets] SET wraiths=0 WHERE wraiths<0");
mysql_query("UPDATE $TABLE[fleets] SET warfrigs=0 WHERE warfrigs<0");
mysql_query("UPDATE $TABLE[fleets] SET astropods=0 WHERE astropods<0");
mysql_query("UPDATE $TABLE[fleets] SET cobras=0 WHERE cobras<0");
mysql_query("UPDATE $TABLE[fleets] SET destroyers=0 WHERE destroyers<0");
mysql_query("UPDATE $TABLE[fleets] SET scorpions=0 WHERE scorpions<0");
mysql_query("UPDATE $TABLE[fleets] SET antennas=0 WHERE antennas<0");

// SCORES (users)
$ss = mysql_query("SELECT * FROM $TABLE[fleets] ORDER BY owner_id;") or die("error_X99".mysql_error());
while ($ssi = mysql_fetch_assoc($ss))
{
	$scores[$ssi[owner_id]] += $ssi[infinitys]*30 + $ssi[wraiths]*100 + $ssi[warfrigs]*500 + $ssi[astropods]*250 + $ssi[cobras]*300 + $ssi[destroyers]*500 + $ssi[scorpions]*700 + $ssi[antennas]*2400;
}
$q = mysql_query("SELECT id FROM $TABLE[users] ORDER BY id;");
while ($i = mysql_fetch_assoc($q))
{
	$score = $scores[$i[id]];
	$sql = "UPDATE $TABLE[users] SET size=asteroid_ui+asteroid_metal+asteroid_crystal, score=((crystal+metal+energy)/100+(asteroid_metal+asteroid_crystal)*1500+rcannons*100+avengers*140+lstalkers*600+waveamps*450+waveblockers*700+$score) WHERE id='$i[id]'";
	mysql_query($sql) or die("error_X100".mysql_error());
}unset($score);


// RANKING (galaxies,alliances,users)
$n=1;
$ranking = mysql_query("SELECT id,x,tag,score,size FROM $TABLE[users] ORDER BY -score,-size,rulername ASC") or die("error_X101".mysql_error());
mysql_query("UPDATE $TABLE[alliances] SET score=0,size=0,num_members=0");
mysql_query("UPDATE $TABLE[galaxies] SET score=0,size=0,num_planets=0");
while ($r = mysql_fetch_assoc($ranking))
{
	mysql_query("UPDATE $TABLE[galaxies] SET score=score+$r[score], size=size+$r[size], num_planets=num_planets+1 WHERE x='$r[x]'") or die("error_X108".mysql_error());
	mysql_query("UPDATE $TABLE[alliances] SET score=score+$r[score], size=size+$r[size],num_members=num_members+1 WHERE tag='$r[tag]';") or die("error_X102".mysql_error());
	mysql_query("UPDATE $TABLE[users] SET rank='$n' WHERE id='$r[id]'") or die("error_X103".mysql_error());
	$n++;
}
mysql_query("UPDATE $TABLE[prefs] SET tickcount=tickcount+1");

if (ceil($MyT/20) == floor($MyT/20))
{
	mysql_query("OPTIMIZE TABLE $TABLE[alliances],$TABLE[galaxies],$TABLE[users],$TABLE[production],$TABLE[news],$TABLE[fleets],$TABLE[mail]") or die("error_X109".mysql_error());
}

?>

<META http-equiv=refresh content=<?=$refreshingtime?>>
Tick done! (<?=($MyT)?>)<br>
Game stops <?=($GAMEPREFS[general_gamestoptick])?"at $GAMEPREFS[general_gamestoptick].":"never!"?>


