<?

include("config.php");

logincheck();

$move_rijen		= 3;
$defences_are_possible	= $GAMEPREFS[military_defend];
$attacks_are_possible	= $GAMEPREFS[military_attack];
$scorelimit_in_attack	= $GAMEPREFS[military_scorelimit];

if ($_POST[check] && $_POST[action]=="move")
{
for ($i=0;$i<$move_rijen;$i++)
{ // begin van de FOR

/*
if ($from[$i] == $to[$i] || (!$nummer[$i] && $_POST[unittype]!="all"))
{
	break;
}
*/

$unittype=$_POST[unittype];
if ($unittype[$i]!="all")
{
	if ($_POST[from][$i] == "base")
	{
		if (stristr($nummer[$i],"-") || stristr($nummer[$i],"+") || stristr($nummer[$i],"("))
		{
			die("Invalid character in amount.");
		}

		if ($war == 0 && $def == 0)
		{
			if ($unittype[$i] == "inf")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $infinitys_base : $nummer[$i];
				$rest = $infinitys_base - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update $TABLE[users] set infinitys_fleet=infinitys_fleet+$nummer[$i], infinitys_base=infinitys_base-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
			if ($unittype[$i] == "wra")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $wraiths_base : $nummer[$i];
				$rest = $wraiths_base - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update $TABLE[users] set wraiths_fleet=wraiths_fleet+$nummer[$i], wraiths_base=wraiths_base-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
			if ($unittype[$i] == "war")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $warfrigs_base : $nummer[$i];
				$rest = $warfrigs_base - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update $TABLE[users] set warfrigs_fleet=warfrigs_fleet+$nummer[$i], warfrigs_base=warfrigs_base-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
			if ($unittype[$i] == "des")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $destroyers_base : $nummer[$i];
				$rest = $destroyers_base - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				$sql = "update $TABLE[users] set destroyers_fleet=destroyers_fleet+$nummer[$i], destroyers_base=destroyers_base-$nummer[$i] WHERE id='$UID'";
				mysql_query ($sql) or die(mysql_error());
			}
			if ($unittype[$i] == "cob")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $cobras_base : $nummer[$i];
				$rest = $cobras_base - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update $TABLE[users] set cobras_fleet=cobras_fleet+$nummer[$i], cobras_base=cobras_base-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
			if ($unittype[$i] == "ast")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $astropods_base : $nummer[$i];
				$rest = $astropods_base - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");	
				}
				mysql_query ("update $TABLE[users] set astropods_fleet=astropods_fleet+$nummer[$i], astropods_base=astropods_base-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
			if ($unittype[$i] == "sco")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $scorpions_base : $nummer[$i];
				$rest = $scorpions_base - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update $TABLE[users] set scorpions_fleet=scorpions_fleet+$nummer[$i], scorpions_base=scorpions_base-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
		}
		else
		{
			Save_Msg("You cant switch units while they are out!","red");
			Go("?");
		}
	}

	if ($_POST[from][$i] == "squad 1")
	{
		if (stristr($nummer[$i],"-") || stristr($nummer[$i],"+") || stristr($nummer[$i],"("))
		{
			die("Invalid character in amount.");
		}
		if ($war == 0 && $def ==0)
		{
			if ($unittype[$i] == "inf")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $infinitys_fleet : $nummer[$i];
				$rest = $infinitys_fleet - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update $TABLE[users] set infinitys_base=infinitys_base+$nummer[$i], infinitys_fleet=infinitys_fleet-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
			if ($unittype[$i] == "wra")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $wraiths_fleet : $nummer[$i];
				$rest = $wraiths_fleet - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update $TABLE[users] set wraiths_base=wraiths_base+$nummer[$i], wraiths_fleet=wraiths_fleet-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
			if ($unittype[$i] == "war")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $warfrigs_fleet : $nummer[$i];
				$rest = $warfrigs_fleet - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update $TABLE[users] set warfrigs_base=warfrigs_base+$nummer[$i], warfrigs_fleet=warfrigs_fleet-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
			if ($unittype[$i] == "des")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $destroyers_fleet : $nummer[$i];
				$rest = $destroyers_fleet - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update $TABLE[users] set destroyers_base=destroyers_base+$nummer[$i], destroyers_fleet=destroyers_fleet-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
			if ($unittype[$i] == "cob")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $cobras_fleet : $nummer[$i];
				$rest = $cobras_fleet - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update $TABLE[users] set cobras_base=cobras_base+$nummer[$i], cobras_fleet=cobras_fleet-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
			if ($unittype[$i] == "ast")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $astropods_fleet : $nummer[$i];
				$rest = $astropods_fleet - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");	
				}
				mysql_query ("update $TABLE[users] set astropods_base=astropods_base+$nummer[$i], astropods_fleet=astropods_fleet-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
			if ($unittype[$i] == "sco")
			{
				$nummer[$i] =  (!$nummer[$i]) ? $scorpions_fleet : $nummer[$i];
				$rest = $scorpions_fleet - $nummer[$i];
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update $TABLE[users] set scorpions_base=scorpions_base+$nummer[$i], scorpions_fleet=scorpions_fleet-$nummer[$i] WHERE id='$UID'") or die(mysql_error());
			}
		}
		else
		{
			Save_Msg("You cant switch units while they are out!","red");
			Go("?");
		}
	}
}
else if ($unittype[$i] == "all")
{
	if (stristr($nummer[$i],"-") || stristr($nummer[$i],"+") || stristr($nummer[$i],"("))
	{
		die("Invalid character in amount.");
	}
	if ($_POST[from][$i] == "base")
	{
		if ($war == 0 && $def ==0)
		{
			$sql = "update $TABLE[users] set infinitys_fleet=infinitys_base+infinitys_fleet, infinitys_base=0 WHERE id='$UID'";
			mysql_query($sql) or die(mysql_error());
			$sql = "update $TABLE[users] set wraiths_fleet=wraiths_base+wraiths_fleet, wraiths_base=0 WHERE id='$UID'";
			mysql_query($sql) or die(mysql_error());
			mysql_query("update $TABLE[users] set warfrigs_fleet=warfrigs_base+warfrigs_fleet, warfrigs_base=0 WHERE id='$UID'") or die(mysql_error());
			mysql_query("update $TABLE[users] set destroyers_fleet=destroyers_base+destroyers_fleet, destroyers_base=0 WHERE id='$UID'") or die(mysql_error());
			mysql_query("update $TABLE[users] set cobras_fleet=cobras_base+cobras_fleet, cobras_base=0 WHERE id='$UID'") or die(mysql_error());
			mysql_query("update $TABLE[users] set astropods_fleet=astropods_base+astropods_fleet, astropods_base=0 WHERE id='$UID'") or die(mysql_error());
			mysql_query("update $TABLE[users] set scorpions_fleet=scorpions_base+scorpions_fleet, scorpions_base=0 WHERE id='$UID'") or die(mysql_error());
		}
		else
		{
			Save_Msg("You cant switch units while they are out!","red");
			Go("?");
		}
	}
	if ($_POST[from][$i] == "squad 1")
	{
		if ($war == 0 && $def ==0)
		{
			$sql = "update $TABLE[users] set infinitys_base=infinitys_fleet+infinitys_base, infinitys_fleet=0 WHERE id='$UID'";
			mysql_query($sql) or die(mysql_error());
			$sql = "update $TABLE[users] set wraiths_base=wraiths_fleet+wraiths_base, wraiths_fleet=0 WHERE id='$UID'";
			mysql_query($sql) or die(mysql_error());
			mysql_query("update $TABLE[users] set warfrigs_base=warfrigs_fleet+warfrigs_base, warfrigs_fleet=0 WHERE id='$UID'") or die(mysql_error());
			mysql_query("update $TABLE[users] set destroyers_base=destroyers_fleet+destroyers_base, destroyers_fleet=0 WHERE id='$UID'") or die(mysql_error());
			mysql_query("update $TABLE[users] set cobras_base=cobras_fleet+cobras_base, cobras_fleet=0 WHERE id='$UID'") or die(mysql_error());
			mysql_query("update $TABLE[users] set astropods_base=astropods_fleet+astropods_base, astropods_fleet=0 WHERE id='$UID'") or die(mysql_error());
			mysql_query("update $TABLE[users] set scorpions_base=scorpions_fleet+scorpions_base, scorpions_fleet=0 WHERE id='$UID'") or die(mysql_error());
		}
		else
		{
			Save_Msg("You cant switch units while they are out!","red");
			Go("?");
		}
	}
}
} // einde van de FOR
Save_Msg("Transfered!","green");
Go("?");
} // einde van de CHECK


// rudie //
$attack = $galaxyarray[$_POST[attackX]][$_POST[attackY]];
if ($_POST[check]==1 && $attack > 0 && $attack!=$UID && $ships_fleet>0)
{
	$result = mysql_query("SELECT * FROM $TABLE[users] WHERE id='$attack'") or die(mysql_error());
	$mr = mysql_fetch_array($result);
	$his_x = $mr[x];

	$energycost = 9 * $ships_fleet;
	if ($attack>=0)
	{
		if ($scorelimit_in_attack)
		{
			if ($mr[score] < $score/$scorelimit_in_attack)
			{
				Save_Msg("The planet is out of your range! The limit is score divided by $scorelimit_in_attack.","red");
				Go("?");
			}
		}
		if (!mysql_num_rows($result))
		{
			Save_Msg("This planet does not exist!","red");
			Go("?");
		}
		if ($mr[sleep])
		{
			Save_Msg("The planet is in sleep mode.","red");
			Go("?");
		}
		if ($mr[newbie])
		{
			Save_Msg("The planet is under protection.","red");
			Go("?");
		}
		if ($energy < $energycost)
		{
			Save_Msg("You need more energy to send your fleet out. You need $energycost energy.","red");
			Go("?");
		}
		if (mysql_num_rows(mysql_query("SELECT id FROM $TABLE[users] WHERE war='$attack'"))>4)
		{
			Save_Msg("The planet's system is already very full with attackers! Your troops don't want to go.","red");
			Go("?");
		}
	}
	if ($attack>0 && $war==0)
	{
		if ($ships_fleet == 0)
		{
			Save_Msg("You need more ships in squadron 1 to attack!","red");
			Go("?");
		}
		if ($his_x == $myrow[x])
		{
		//	Save_Msg("You are not allowed to attack in your own galaxy!","red");
		//	Go("?");
		}
		if ($newbie)
		{
			Save_Msg("You are not allowed to attack while you are under protection!","red");
			Go("?");
		}

		AddNews("incoming","<b>$USERNAME</b> (#$UID) sent <b>$ships_fleet ships</b> to attack us; ETA $ETA_attacking ticks!",$attack);
		AddNews("outgoing","We sent <b>$ships_fleet ships</b> to attack <b>".$userarray[$attack]."</b> (#$attack); ETA $ETA_attacking ticks!",$UID,1);

		mysql_query("UPDATE $TABLE[users] SET war='$attack', wareta='".($ETA_attacking+5)."', energy=energy-$energycost, motd='$his_x' WHERE id='$UID' AND energy>0") or die(mysql_error());
	}
   
	if ($war>0)
	{
		AddNews("incoming","<b>$USERNAME</b> (#$UID) recalled his fleet!",$war);
		AddNews("outgoing","We recalled our fleet, attacking <b>".$userarray[$war]."</b> (#$war)!",$UID,1);

		if ($wareta>=6)
			mysql_query("UPDATE $TABLE[users] SET war='-1',wareta=".($ETA_attacking+5)."-wareta WHERE id='$UID'") or die(mysql_error());
		else
			mysql_query("UPDATE $TABLE[users] SET war='-1',wareta='$ETA_attacking' WHERE id='$UID'") or die(mysql_error());
	}

	Go("?");
}

$defend = $galaxyarray[$_POST[defendX]][$_POST[defendY]];
if ($_POST[check]==1 && $defend>-2 && $defend!=$UID && $ships_fleet>0)
{
	$result = mysql_query("SELECT * FROM $TABLE[users] WHERE id='$defend'") or die(mysql_error());
	$mr = mysql_fetch_array($result);
	$his_x = $mr[x];

	if ($defend>=0)
	{
		if (!mysql_num_rows($result))
		{
			Save_Msg("This planet does not exist!","red");
			Go("?");
		}

	}

	if ($defend>0 && $war==0 && $def==0)
	{
		mysql_query("UPDATE $TABLE[users] SET motd='$his_x', def='$defend', wareta='".($ETA_defending+10)."' WHERE id='$UID'") or die(mysql_error());
		AddNews("incoming","<b>$USERNAME</b> (#$UID) is defending you, ETA $ETA_defending ticks.",$defend);
		AddNews("outgoing","We are defending <b>".$userarray[$defend]."</b> (#$defend), ETA $ETA_defending ticks.",$UID,1);
	}

	if ($defend<0 && $def>0)
	{
		AddNews("incoming","<b>$USERNAME</b> (#$UID) recalled his fleet!",$def);
		AddNews("outgoing","We recalled our fleet, defending <b>".$userarray[$def]."</b> (#$war)!",$UID,1);

		if ($wareta>=10)
			mysql_query("UPDATE $TABLE[users] SET war='-1',wareta='".(($ETA_defending+10)-$wareta)."',def=0 WHERE id='$UID'") or die(mysql_error());
		else
			mysql_query("UPDATE $TABLE[users] SET war='-1',wareta='$ETA_defending',def=0 WHERE id='$UID'" or die(mysql_error()));
	}

	Go("?");
}

if ($_POST[check]==1 && $_POST[losefleet]==1)
{
	mysql_query("UPDATE $TABLE[users] SET infinitys_fleet=0,wraiths_fleet=0,warfrigs_fleet=0,destroyers_fleet=0,cobras_fleet=0,astropods_fleet=0,scorpions_fleet=0,war=0,def=0,wareta=0 WHERE id='$UID'");

	Save_Msg("You just killed all of your employees and destructed your entire fleet!","green");
	Go("?");
}

include("header.php");

?>
<table border=0 cellpadding=2 cellspacing=0 width=100%>
<tr><td style='border:solid 1px #444444;'><center><b>Military</b></td></tr>
</table>
<br>
<?

$result = mysql_query("SELECT * FROM $TABLE[users] WHERE id='$UID' AND closed='0'") or die(mysql_error());
$myrow = mysql_fetch_assoc($result) or die(mysql_query());
  
echo "<table border=0 cellpadding=3 cellspacing=0 width=500>";
echo "<tr><td width=150><br></td><td><center>BASE</td><td><center>SQUAD I</td></tr>";
echo "<tr><td align=right>Infinitys:</td><td><center>$infinitys_base</td><td><center>$infinitys_fleet</td></tr>";
echo "<tr><td align=right>Wraiths:</td><td><center>$wraiths_base</td><td><center>$wraiths_fleet</td></tr>";
echo "<tr><td align=right>Warfrigates:</td><td><center>$warfrigs_base</td><td><center>$warfrigs_fleet</td></tr>";
echo "<tr><td align=right>Destroyers:</td><td><center>$destroyers_base</td><td><center>$destroyers_fleet</td></tr>";
echo "<tr><td align=right>Cobras:</td><td><center>$cobras_base</td><td><center>$cobras_fleet</td></tr>";
echo "<tr><td align=right>Astropods:</td><td><center>$astropods_base</td><td><center>$astropods_fleet</td></tr>";
echo "<tr><td align=right>Scorpions:</td><td><center>$scorpions_base</td><td><center>$scorpions_fleet</td></tr>";
echo "</table><br><br><br>";

?>
<table border=0 cellpadding=2 cellspacing=0 width=100%>
<form name=move action=? method=post><input type=hidden name=check value=1><input type=hidden name=action value="move">
<tr><td style='border:solid 1px #444444;'><center><b>Squadron management</b></td></tr>
</table>
<br>
With squadrons, you can select what units you want to attack with. Put at least one unit in a squadron to attack.<br>
<br>
<table border=1 cellpadding=3 cellspacing=2 width=500 bordercolor=#444444 style='border:none;'>
<tr><td>UNIT TYPE</td><td>AMOUNT</td><td>FROM</td><td>TO</td></tr>
<? for ($i=0;$i<$move_rijen;$i++) { ?>
<tr>
<td width=150>
<select name="unittype[]" style='width:100%;'>
<option SELECTED>-SELECT UNITS
<option value="all">ALL UNITS
<option value="inf">Infinitys
<option value="wra">Wraiths
<option value="war">Warfrigates
<option value="des">Destroyers
<option value="cob">Cobras
<option value="ast">Astropods
<option value="sco">Scorpions
</select>
</td>
<td width=150>
<input type=text name="nummer[]" style='width:100%;' autocomplete=off>
</td>
<td width=100>
<select name="from[]" style='width:100%;'>
<option value="base" SELECTED>BASE
<option value="squad 1" >SQUAD I
</select>
</td>
<td width=100>
<select name="to[]" style='width:100%;'>
<option value="base" SELECTED>BASE
<option value="squad 1">SQUAD I
</select>
</td> 
</tr>
<? } ?>
<tr><td colspan=4><input type=submit name=send value="Move Units" style='width:100%;font-weight:bold;font-size:13px;color:lime;'></td></tr>
</form></table>
<br>
<br>


<font color=blue><b>Cost to send out <?=nummertje($ships_fleet)?> units to attack: <?=nummertje($energycost)?> energy</b></font><br>
ETA (attack) = <?=$ETA_attacking?>; will attack for 5 ticks.<br>
ETA (defend) = <?=$ETA_defending?>; will defend for 10 ticks.<br>
<br>
<br>

<?

if ($war<0)
{
	echo "Returning... (ETA: ".($wareta).")<br><br><table border=0 cellpadding=0 cellspacing=0><tr><form name=losefleet action=? method=post><input type=hidden name=check value=1><input type=hidden name=losefleet value=1><td><input type=submit value=\"Selfdestruct\"></td></form></tr></table>";
}

if ($wareta>=5 && $war>0)
	echo "<font color=red>Attacking <b>$userarray[$war]</b> (".$xcoordarray[$war].":".$ycoordarray[$war].")... (ETA: ".($wareta-5).")</font><br>";
if ($wareta<5 && $war>0)
	echo "<font color=red>Attacking <b>$userarray[$war]</b> (".$xcoordarray[$war].":".$ycoordarray[$war].")... ($wareta more ticks)</font><br>";
if ($wareta>=11 && $def>0)
	echo "<font color=green>Defending <b>$userarray[$def]</b> (".$xcoordarray[$def].":".$ycoordarray[$def].")... (ETA: ".($wareta-10).")</font><br>";
if ($wareta<11 && $def>0)
	echo "<font color=green>Defending <b>$userarray[$def]</b> (".$xcoordarray[$def].":".$ycoordarray[$def].")... (ETA: 0)</font><br>";

if ($war>0 || $def>0)
{
	$action = ($war>0)?"attack":"defend";
	echo "<br><table border=0 cellpadding=0 cellspacing=0><tr><form name=recallfleet action=? method=post><input type=hidden name=check value=1><input type=hidden name=$action value=-1><td><input type=submit value=\"Recall\"></td></form><td>&nbsp or &nbsp</td><form name=losefleet action=? method=post><input type=hidden name=check value=1><input type=hidden name=losefleet value=1><td><input type=submit value=\"Selfdestruct\"></td></form></tr></table>";
}

if ($war==0 && $def==0) // fleet home!
{
	?>
	<script>
	function loginpopup(type)
	{
		loginwin = window.open('planets.php?type='+type,'loginwin','toolbar=0,location=0,directories=0,status=1,menubar=0,scrollbars=1,resizable=1,width=450,height=250,left=' + (window.screen.width-450)/2 + ',top=' + (window.screen.height-400)/2);
		loginwin.focus();
	}
	</script>



	ATTACK:<br>
	<table border=0 cellpadding=3 cellspacing=0>
	<form action=? method=post name="attackscan"><input type=hidden name=check value=1>
	<tr><td>Coordinates:</td></tr>
	<tr><td><input type=text name=attackX style='width:30;text-align:center;' autocomplete=off>:<input type=text name=attackY style='width:30;text-align:center;' autocomplete=off><tr><td><input type=submit value="Attack"<?=($_SERVER[HTTP_HOST]!="localhost" && !$attacks_are_possible)?" disabled":""?>></td></tr>
	</form></table>

	<br>
	<br>

	DEFEND:<br>
	<table border=0 cellpadding=3 cellspacing=0>
	<form action=? method=post name="defendscan"><input type=hidden name=check value=1>
	<tr><td>Coordinates:</td></tr>
	<tr><td><input type=text name=defendX style='width:30;text-align:center;' autocomplete=off>:<input type=text name=defendY style='width:30;text-align:center;' autocomplete=off><tr><td><input type=submit value="Defend"<?=($_SERVER[HTTP_HOST]!="localhost" && !$defences_are_possible)?" disabled":""?>></td></tr>
	</form></table>
	<?
}

echo "<br>";


include("footer.php");


