<?

include("config.php");

logincheck();

$order=$_POST[order];
if ($_POST[check] == 1 && $_POST[action] == "orderunits")
{
	foreach ($order AS $t => $a)
	{
		if ($a>0)
		{
			$eta = $productionarray[$t][2];
			$km = $productionarray[$t][3];
			$kc = $productionarray[$t][4];
			$need = $productionarray[$t][5];
			if ($a*$km>$metal || $a*$kc>$crystal)
			{
				$na[m]=($km)?floor($metal/$km):9999999;
				$na[c]=($kc)?floor($crystal/$kc):9999999;
				$a = min($na);
			}
			$sql = "INSERT INTO $TABLE[production] (uid,unit,eta,number,prodtype) VALUES ('$UID','$t','$eta','$a','u')";
			mysql_query($sql) or die(mysql_error());
			mysql_query("UPDATE $TABLE[users] SET metal=metal-".($km*$a).",crystal=crystal-".($kc*$a)." WHERE id='$UID' AND metal>=".($km*$a)." AND crystal>=".($kc*$a)." AND $need=1");
			$metal -= $km*$a;
			$crystal -= $kc*$a;
		}
	}
	Save_Msg("Units ordered!","green");
	Go("?");
}


include("header.php");

?>

<table border=0 cellpadding=2 cellspacing=0 width=100%>
<tr><td style='border:solid 1px #444444;'><center><b>Production</b></td></tr>
</table>
<br>

<table border=0 bordercolor=#dddddd cellpadding=0 cellspacing=2 width=100% style='border:none;'>
<form name=orderscans method=post action=production.php><input type=hidden name=check value=1><input type=hidden name=action value="orderunits">
<?

Production_entry("<b>Name","<b>Description","<b>ETA","<b>Cost","<b>Stock","<b>Number");

foreach ($productionarray AS $soort => $inhoud)
{
	if (strlen($soort)==1 && $c_pdu1==1)
	{
		echo "<tr height=8 bgcolor=black><td colspan=6></td></tr>\n";
	}
	else
	{
		if ($$inhoud[5] == 1)
		{
			$stock = ($soort=="rcannons" || $soort=="avengers" || $soort=="lstalkers") ? $$soort : $NUMSHIPS[$soort];
			$a++;
			Production_Entry($inhoud[0],$inhoud[1],$inhoud[2],"<font color=$showcolors[metal]>".nummertje($inhoud[3])." metal</font><br><font color=$showcolors[crystal]>".nummertje($inhoud[4])." crystal</font>",nummertje($stock),"<input type=text name=order[$soort] style='width:53px;text-align:center;' autocomplete=off maxlength=6><!--<input style='width:21px;' type=button value=\"M\" OnClick=\"document.orderscans.order[$soort].value='8';\">-->");
		}
	}
}

$prod = mysql_query("SELECT * FROM $TABLE[production] WHERE uid='$UID' AND prodtype='u' GROUP BY unit ORDER BY unit,eta") or die(mysql_error());
$lastone = mysql_num_rows($prod);

?>
<tr><td colspan=5><?/*<center><b style='cursor:pointer;' OnClick="window.open('calc.php','calculator','width=400,height=500');">Calculator*/?></td><td><center><input type=submit value="Order"<?=(!($a && $USER[ready2play]))?" disabled":""?>></td></tr>
</form>
</table>
<br>
<? if ($lastone) { ?>
<br>

</td></tr></table>
<table border=1 bordercolor=#dddddd cellpadding=1 cellspacing=2 style='border:none;'>
<tr height=20 align=right><td><b>Unit</td>
<?

$me = mysql_query("SELECT eta FROM $TABLE[production] WHERE uid='$UID' AND prodtype='u' ORDER BY -eta LIMIT 1") or die(mysql_error());
$maxeta = mysql_result($me,0,'eta');

for ($i=0;$i<$maxeta;$i++)
{
	echo "<td><center>".($i+1)."</td>\n";
}
echo "</tr><tr height=20>";
$lasteta=0;
while ($pi = mysql_fetch_assoc($prod))
{
	$lastone--;
	echo "<td align=right><b>".$productionarray[$pi[unit]][0]."</td>";
	$thisprod = mysql_query("SELECT *,SUM(number) AS total_num FROM $TABLE[production] WHERE uid='$UID' AND unit='$pi[unit]' GROUP BY eta") or die(mysql_error());
	while ($pi2 = mysql_fetch_assoc($thisprod))
	{
		for ($j=$lasteta;$j<$pi2[eta]-1;$j++)
		{
			echo "<td></td>";
			$lasteta++;
		}
			$lasteta++;
		echo "<td>".nummertje($pi2[total_num])."</td>";
	}
	echo ($lastone>0) ? "</tr><tr>" : "";
	$lasteta=0;
}

echo "</tr></table><table border=0 cellpadding=0 cellspacing=0 width=700><tr valign=top><td><br>";
}

include("footer.php");


