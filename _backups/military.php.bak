<?

require "dblogon.php";
require "options.php";

logincheck();


if ($unittype!="all")
{
	if ($_POST[from] == "base")
	{
		if (stristr($nummer,"-") || stristr($nummer,"+") || stristr($nummer,"("))
		{
			die("Invalid character in amount.");
		}

		if ($war == 0 && $def ==0)
		{
			if ($unittype == "infantrists")
			{
				$nummer =  (!$nummer) ? $infantry_base : $nummer;
				$rest = $infantry_base - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update pa_users set infinitys=infinitys+$nummer, infinitys_base=infinitys_base-$nummer WHERE id='$UID'");
			}
			if ($unittype == "grabbers")
			{
				$nummer =  (!$nummer) ? $grabber_base : $nummer;
				$rest = $grabber_base - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");	
				}
				mysql_query ("update pa_users set astropods=astropods+$nummer, astropods_base=astropods_base-$nummer WHERE id='$UID'");
			}
			if ($unittype == "shadows")
			{
				$nummer =  (!$nummer) ? $shadows_base : $nummer;
				$rest = $shadows_base - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update pa_users set wraiths=wraiths+$nummer, wraiths_base=wraiths_base-$nummer WHERE id='$UID'");
			}
			if ($unittype == "goliaths")
			{
				$nummer =  (!$nummer) ? $goliath_base : $nummer;
				$rest = $goliath_base - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update pa_users set warfrigs=warfrigs+$nummer, warfrigs_base=warfrigs_base-$nummer WHERE id='$UID'");
			}
			if ($unittype == "hellspawns")
			{
				$nummer =  (!$nummer) ? $hellspawn_base : $nummer;
				$rest = $hellspawn_base - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update pa_users set destroyers=destroyers+$nummer, destroyers_base=destroyers_base-$nummer WHERE id='$UID'");
			}
			if ($unittype == "ares")
			{
				$nummer =  (!$nummer) ? $ares_base : $nummer;
				$rest = $ares_base - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update pa_users set scorpions=scorpions+$nummer, scorpions_base=scorpions_base-$nummer WHERE id='$UID'");
			}

			Header("Location: ?");
		}
	}

	if ($_POST[from] == "squad 1")
	{
		if (stristr($nummer,"-") || stristr($nummer,"+") || stristr($nummer,"("))
		{
			die("Invalid character in amount.");
		}
		if ($war == 0 && $def ==0)
		{
			if ($unittype == "infantrists")
			{
				$rest = $infantry - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update pa_users set infinitys_base=infinitys_base+$nummer, infinitys=infinitys-$nummer WHERE id='$UID'");
			}
			if ($unittype == "grabbers")
			{
				$rest = $grabber - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");	
				}
				mysql_query ("update pa_users set astropods_base=astropods_base+$nummer, astropods=astropods-$nummer WHERE id='$UID'");
			}
			if ($unittype == "shadows")
			{
				$rest = $shadows - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update pa_users set wraiths_base=wraiths_base+$nummer, wraiths=wraiths-$nummer WHERE id='$UID'");
			}
			if ($unittype == "goliaths")
			{
				$rest = $goliath - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update pa_users set warfrigs_base=warfrigs_base+$nummer, warfrigs=warfrigs-$nummer WHERE id='$UID'");
			}
			if ($unittype == "hellspawns")
			{
				$rest = $hellspawn - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update pa_users set destroyers_base=destroyers_base+$nummer, destroyers=destroyers-$nummer WHERE id='$UID'");
			}
			if ($unittype == "ares")
			{
				$rest = $ares - $nummer;
				if ($rest < 0)
				{
					die("You need more units to transfer!");
				}
				mysql_query ("update pa_users set scorpions_base=scorpions_base+$nummer, scorpions=scorpions-$nummer WHERE id='$UID'");
			}
	
			Header("Location: ?");
		}
	}
}
else // unittype = all
{
	if (stristr($nummer,"-") || stristr($nummer,"+") || stristr($nummer,"("))
	{
		die("Invalid character in amount.");
	}
	if ($_POST[from] == "base")
	{
		if ($war == 0 && $def ==0)
		{
			mysql_query("update pa_users set infinitys=infinitys_base+infinitys, infinitys_base=0 WHERE id='$UID'");
			mysql_query("update pa_users set astropods=astropods_base+astropods, astropods_base=0 WHERE id='$UID'");
			mysql_query("update pa_users set wraiths=wraiths_base+wraiths, wraiths_base=0 WHERE id='$UID'");
			mysql_query("update pa_users set warfrigs=warfrigs_base+warfrigs, warfrigs_base=0 WHERE id='$UID'");
			mysql_query("update pa_users set destroyers=destroyers_base+destroyers, destroyers_base=0 WHERE id='$UID'");
			mysql_query("update pa_users set scorpions=scorpions_base+scorpions, scorpions_base=0 WHERE id='$UID'");
		}
	}
	if ($_POST[from] == "squad 1")
	{
		if ($war == 0 && $def ==0)
		{
			mysql_query("update pa_users set infinitys_base=infinitys+infinitys_base, infinitys=0 WHERE id='$UID'");
			mysql_query("update pa_users set astropods_base=astropods+astropods_base, astropods=0 WHERE id='$UID'");
			mysql_query("update pa_users set wraiths_base=wraiths+wraiths_base, wraiths=0 WHERE id='$UID'");
			mysql_query("update pa_users set warfrigs_base=warfrigs+warfrigs_base, warfrigs=0 WHERE id='$UID'");
			mysql_query("update pa_users set destroyers_base=destroyers+destroyers_base, destroyers=0 WHERE id='$UID'");
			mysql_query("update pa_users set scorpions_base=scorpions+scorpions_base, scorpions=0 WHERE id='$UID'");
		}
	}
}



$ships = $myrow["astropods"]+$myrow["infinitys"]+$myrow["wraiths"]+$myrow["warfrigs"]+$myrow["destroyers"]+$myrow["scorpions"];
$energycost = 9 * $ships;
if ($attack>-2 && $attack!=$UID && $attack!="" && $ships>0)
{
	if ($attack>=0){
		$result = mysql_query("SELECT * FROM ".$PA["table"]." WHERE id='$attack'");
		if (mysql_num_rows($result)!=1) {
			header("Location: ?msgred=No such country!");
			die;
		}
		$mr = mysql_fetch_array($result);
if ($mr["sleep"]!=0) { Header("Location: ?msgred=The planet is in sleep mode."); die(); }
if ($mr["newbie"]!=0) { Header("Location: ?msgred=The planet is under protection."); die(); }
if ($energy<$energycost && $energy < 10) { Header("Location: ?msgred=You need more energy to send your fleet out."); die(); }

$rest = $energy - $energycost;
if ($rest < 10) { Header("Location: ?msgred=You need more energy to send your fleet out."); die(); }


		if ($mr["score"]<$score / 15) { Header("Location: ?msgred=The country is out of your range! The limit is score divided by 15."); die(); }


	}

	if ($attack>0 && $myrow["war"]==0) {

if ($ships == 0)
	die("You need more ships in squadron 1 to attack!");

$minxx = $mr["x"];
if ($minxx == $myrow["x"]) { require "header.php"; echo "You are not allowed to attack in your own continent!"; die("");}
if ($newbie!=0) { require "header.php"; echo "You are not allowed to attack while under protection!"; die("");}

$result = mysql_query("UPDATE ".$PA["table"]." SET energy=energy-$energycost WHERE id='$UID' AND energy>0");
$result = mysql_query("UPDATE ".$PA["table"]." SET motd=$minxx WHERE id='$UID'");
Add_news("Incoming hostile fleet","$USERNAME #$UID is attacking you, ETA 30 mins.",$attack);


$result = mysql_query("UPDATE ".$PA["table"]." SET war='$attack',wareta='35' WHERE id='$UID'"); }
   
/*if ($attack<0 && $myrow["war"]>0)*/
 if ($myrow["war"]>0)
	{
		Add_news("Recall","$USERNAME #$UID recalled his fleet.",$myrow["war"]);
		if ($wareta>=6) $result = mysql_query("UPDATE ".$PA["table"]." SET war='-1',wareta=35-wareta WHERE id='$UID'");
		else $result = mysql_query("UPDATE ".$PA["table"]." SET war='-1',wareta='30' WHERE id='$UID'");
	}
	header("Location: ?");
	die;
}

if ($defend>-2 && $defend!=$UID && $defend!="" && $ships>0)
{
	if ($defend>=0){
		$result = mysql_query("SELECT * FROM ".$PA["table"]." WHERE id='$defend'");
		if (mysql_num_rows($result)!=1) {
			header("Location: ?msgred=No such country!");
			die;
		}
		$mr = mysql_fetch_array($result);
		#if ($mr["score"]<$score / 7) { Header("Location: ?msgred=The country is out of your range!"); die(); }
	}

	if ($defend>0 && $myrow["war"]==0 && $myrow["def"]==0) 
{ 
if ($mr["x"] == $myrow["x"])
{
$minxx = $mr["x"];
$result = mysql_query("UPDATE ".$PA["table"]." SET motd=$minxx WHERE id='$UID'");
Add_news("Incoming friendly fleet","$USERNAME #$UID is defending you, ETA 20 mins.",$defend); $result = mysql_query("UPDATE ".$PA["table"]." SET def='$defend',wareta='25' WHERE id='$UID'");
}

if ($mr["x"] != $myrow["x"])
{
$minxx = $mr["x"];
$result = mysql_query("UPDATE ".$PA["table"]." SET motd=$minxx WHERE id='$UID'");

Add_news("Incoming friendly fleet","$USERNAME #$UID is defending you, ETA 20 mins.",$defend); $result = mysql_query("UPDATE ".$PA["table"]." SET def='$defend',wareta='30' WHERE id='$UID'");
} 
}

	if ($defend<0 && $myrow["def"]>0)
	{
		Add_news("Recall","$USERNAME #$UID recalled his fleet.",$myrow["def"]);
		if ($wareta>=10) $result = mysql_query("UPDATE ".$PA["table"]." SET war='-1',wareta='".(30-$wareta)."',def=0 WHERE id='$UID'");
		else $result = mysql_query("UPDATE ".$PA["table"]." SET war='-1',wareta='20',def=0 WHERE id='$UID'");
	}

	header("Location: ?");
	die;
}

require "header3.php";

?>
<table border=0 cellpadding=2 cellspacing=0 width=100%>
<tr><td style='border:solid 1px black;'><center><b>Military</b></td></tr>
</table>
<br>
<?

$result = mysql_query("SELECT * FROM $PA[table] WHERE id='$UID' AND closed='0'");


$myrow = mysql_fetch_assoc($result) or die(mysql_query());

   
	echo "<table border=0 cellpadding=3 cellspacing=0 width=500>";


$null = 0;

	echo "<tr><td width=150><br></td><td><center>BASE</td><td><center>SQUAD I</td></tr>";
	echo "<tr><td align=right>Infantrists:</td><td><center>".$myrow["infinitys_base"]."</td><td><center>".$myrow["infinitys"]."</td></tr>";
	echo "<tr><td align=right>Shadows:</td><td><center>".$myrow["wraiths_base"]."</td><td><center>".$myrow["wraiths"]."</td></tr>";
	echo "<tr><td align=right>Goliaths:</td><td><center>".$myrow["warfrigs_base"]."</td><td><center>".$myrow["warfrigs"]."</td></tr>";
	echo "<tr><td align=right>Hellspawns:</td><td><center>".$myrow["destroyers_base"]."</td><td><center>".$myrow["destroyers"]."</td></tr>";
	echo "<tr><td align=right>Medusas:</td><td><center>".$myrow["cobras"]."</td><td><center>".$null."</td></tr>";
	echo "<tr><td align=right>Grabbers:</td><td><center>".$myrow["astropods_base"]."</td><td><center>".$myrow["astropods"]."</td></tr>";
	echo "<tr><td align=right>Ares:</td><td><center>".$myrow["scorpions_base"]."</td><td><center>".$myrow["scorpions"]."</td></tr>";
	echo "</table><br><br><br>";

?>
<table border=0 cellpadding=2 cellspacing=0 width=100%>
<form name=move action=? method=post>
<tr><td style='border:solid 1px black;'><center><b>Squadron management</b></td></tr>
</table>
<br>
With squadrons, you can select what units you want to attack with. Put at least one unit in a squadron to attack. You can not transfer Medusas, since they are not an offensive unit.<br>
<br>
<table border=1 cellpadding=3 cellspacing=0 width=500>
<tr><td>UNIT TYPE</td><td>AMOUNT</td><td>FROM</td><td>TO</td></tr>
<tr>
<td width=150>
<select name="unittype" style='width:100%;'>
<option value="all" SELECTED>ALL UNITS
<option value="infantrists">Infantrists
<option value="shadows">Shadows
<option value="goliaths">Goliath
<option value="hellspawns">Hellspawns
<option value="grabbers">Grabbers
<option value="ares">Ares
</select>
</td>
<td width=150>
<input type=text name=nummer style='width:100%;'>
</td>
<td width=100>
<select name="from" style='width:100%;'>
<option value="base" SELECTED>BASE
<option value="squad 1" >SQUAD I
</select>
</td>
<td width=100>
<select name="to" style='width:100%;'>
<option value="base" SELECTED>BASE
<option value="squad 1">SQUAD I
</select>
</td> 
</tr>
<tr><td colspan=4><input type=submit name=send value="Move Units" style='width:100%;'></td></tr>
</form></table>
<br>
<br>


<?	  

echo "<table><td><b><font color=lime>Cost to send out $ships units to attack:  ".number_format($energycost,0,".",".")." energy<br>(Defending is free)</font></td><td></td><tr><tr></table></b>";


$result = mysql_query("SELECT * FROM ".$PA["table"]." WHERE war='$UID'");
if ($myrow = mysql_fetch_array($result))
{
	echo "<font color=\"red\">Hostile incoming fleets:<br>";
	do {
		echo $myrow["nick"]." #".$myrow["id"]." (ETA: ".($myrow["wareta"]-5).")<br>";
	} while ($myrow = mysql_fetch_array($result));
	echo "</font><br><br>";
}

$result = mysql_query("SELECT * FROM ".$PA["table"]." WHERE def='$UID'");
if ($myrow = mysql_fetch_array($result))
{
	echo "<font color=\"green\">Friendly incoming fleets:<br>";
	do {
		echo $myrow["nick"]." #".$myrow["id"]." (ETA: ".($myrow["wareta"]-10).")<br>";
	} while ($myrow = mysql_fetch_array($result));
	echo "</font><br><br>";
}



if ($war<0) echo "Returning... (ETA: ".($wareta).")<br>";

if ($war>0) {
	$result = mysql_query("SELECT * FROM ".$PA["table"]." WHERE id='$war'");
	$myrow = mysql_fetch_array($result);
	$warname = $myrow["nick"];
}

if ($def>0) {
	$result = mysql_query("SELECT * FROM ".$PA["table"]." WHERE id='$def'");
	$myrow = mysql_fetch_array($result);
	$defname = $myrow["nick"];
}

if ($wareta>=5 && $war>0) echo "Attacking $warname #$war... (ETA: ".($wareta-5).")<br>";
if ($wareta<5 && $war>0) echo "Attacking $warname #$war... (ETA: 0)<br>";

if ($wareta>=11 && $def>0) echo "Defending $defname #$def... (ETA: ".($wareta-10).")<br>";
if ($wareta<11 && $def>0) echo "Defending $defname #$def... (ETA: 0)<br>";

if ($war>0) echo("<form action=\"$PHP_SELF\" METHOD=\"POST\"><input type=\"hidden\" name=\"attack\" value=\"-1\"><input type=\"submit\" value=\"Retreat\"></form>");
if ($def>0) echo("<form action=\"$PHP_SELF\" METHOD=\"POST\"><input type=\"hidden\" name=\"defend\" value=\"-1\"><input type=\"submit\" value=\"Retreat\"></form>");

if ($war==0 && $def==0)
{

	echo("<SCRIPT LANGUAGE=\"JavaScript\"><!--
function loginpopup()
{
loginwin = window.open('planets.php?var=attack','loginwin','toolbar=0,location=0,directories=0,status=1,menubar=0,scrollbars=1,resizable=1,width=450,height=250,left=' + (window.screen.width-450)/2 + ',top=' + (window.screen.height-400)/2);
loginwin.focus();
}
//--></SCRIPT>

<SCRIPT LANGUAGE=\"JavaScript\"><!--
function loginpopup2()
{
loginwin = window.open('planets.php?var=defend','loginwin','toolbar=0,location=0,directories=0,status=1,menubar=0,scrollbars=1,resizable=1,width=450,height=250,left=' + (window.screen.width-450)/2 + ',top=' + (window.screen.height-400)/2);
loginwin.focus();
}
//--></SCRIPT>");


	echo "Launch attack <font size=\"1\">(ETA 30, will attack for 5 ticks)</font>:<br><table><td><font size=\"1\">Country ID #:<br><A href=\"javascript:loginpopup();\">Find</font></td><tr>";

	echo "<form action=\"$PHP_SELF\" METHOD=\"POST\"  name=\"form1\">";

	echo "<td><input type=\"text\" name=\"attack\" size=\"7\"><tr><td><input type=\"Submit\" value=\"Attack\"></td></table>";

	echo "Defend <font size=\"1\">(ETA 20, will defend for 10 ticks)</font>:<br><table><td><font size=\"1\">Country ID #:<br><A href=\"javascript:loginpopup2();\">Find</font></td><tr>";


	echo "<td><input type=\"text\" name=\"defend\" size=\"7\"><tr><td><input type=\"Submit\" value=\"Defend\"></td></form></table>";
}


require "footer.php";
?>
