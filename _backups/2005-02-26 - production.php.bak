<?

include("config.php");

logincheck();

// productionarray: soort(naam,uitleg,eta,metal,crystal,rescon_nodig)
$productionarray =array('infinitys'=>array('Infinitys','Small weak ships who make up their little powers with their agility and speed.','10','0','300','c_pinf'),
			'wraiths'=>array('Wraiths','Slightly bigger ships with slower though stronger weapons. Also high agility and speed.','20','1000','0','c_pwra'),
			'warfrigs'=>array('Warfrigates','Warfrigates are real warships! Big ships loaded with lowspeed cannons and highspeed machineguns.','30','2500','2500','r_pwarast'),
			'astropods'=>array('Astropods','The Astropod is the only ship that can steal roids from others. Astropods are slow and weak and cant shoot. They die on success.','40','1250','1250','r_pwarast'),
			'cobras'=>array('Cobras','Very strong and armoured ships! Blocks but not kills Astropods. A musthave in the modern army!','60','0','3000','r_pcob'),
			'destroyers'=>array('Destroyers','The biggest of all heavy duty warships! Quite an investment, but very efficient in combat!','60','2000','3000','c_pdes'),
			'scorpions'=>array('Scorpion','Great ships, <u>very stealth</u> and quite manouvrable and fast. A Cobra\'s worst enemy!','85','6000','1000','c_psco'),
			'a',
			'rcannons'=>array('Reaper Cannons','Best PDU against Astropods. This unit is a musthave in your Planetary Defense!','20','1000','0','c_pdu1'),
			'avengers'=>array('Avengers','Avengers are of a new generation of PDU. They select their targets and are therefore very efficient!','30','800','800','c_pdu1'),
			'lstalkers'=>array('Lucius Stalkers','Very heavy Defense Unit, which can only be killed by Wraiths. Lucius Stalkers go for the big fishes of the attacker!','60','3000','3000','c_pdu2'));


$order=$_POST[order];
if ($_POST[check] == 1 && $_POST[action] == "orderunits")
{
	foreach ($order AS $t => $a)
	{
		if ($a>0)
		{
			$eta = $productionarray[$t][2];
			$km = $productionarray[$t][3];
			$kc = $productionarray[$t][4];
			$need = $productionarray[$t][5];
			if ($a*$km>$metal || $a*$kc>$crystal)
			{
				$na[m]=($km)?floor($metal/$km):9999999;
				$na[c]=($kc)?floor($crystal/$kc):9999999;
				$a = min($na);
			}
			$sql = "INSERT INTO $TABLE[production] (uid,unit,eta,number,u_of_w) VALUES ('$UID','$t','$eta','$a','u')";
			mysql_query($sql) or die(mysql_error());
			mysql_query("UPDATE $TABLE[users] SET metal=metal-".($km*$a).",crystal=crystal-".($kc*$a)." WHERE id='$UID' AND metal>=".($km*$a)." AND crystal>=".($kc*$a)." AND $need=1");
			$metal -= $km*$a;
			$crystal -= $kc*$a;
		}
	}
	Save_Msg("Units ordered!","green");
	Go("?");
}


include("header.php");

?>

<table border=0 cellpadding=2 cellspacing=0 width=100%>
<tr><td style='border:solid 1px #444444;'><center><b>Units</b></td></tr>
</table>
<br>

<table border=1 bordercolor=#dddddd cellpadding=5 cellspacing=2 width=100% style='border:none;'>
<form name=orderscans method=post action=production.php><input type=hidden name=check value=1><input type=hidden name=action value="orderunits">
<?

Production_entry("Name:","<b>Description:","<b>ETA:","<b>Cost:","<b>Stock:","Production:");

foreach ($productionarray AS $soort => $inhoud)
{
	if (strlen($soort)==1)
	{
		echo "<tr height=8 bgcolor=black><td colspan=6></td></tr>\n";
	}
	else
	{
		$cn = "p_".$soort;
		$production = ($$cn == 0) ? "<input type=text name=order[$soort] style='width:60;text-align:center;' autocomplete=off>" : "Building<br>".$$cn;
		$eta = ($$cn == 0) ? $inhoud[2] : "<b>".(${$cn.t}-1);
		if ($$inhoud[5] == 1)
		{
			$a++;
			Production_Entry($inhoud[0],$inhoud[1],$eta,"$inhoud[3] metal<br>$inhoud[4] crystal",$$soort,$production);
		}
	}
}

$prod = mysql_query("SELECT * FROM $TABLE[production] WHERE uid='$UID' AND u_of_w='u' GROUP BY unit ORDER BY unit,eta") or die(mysql_error());
$lastone = mysql_num_rows($prod);

?>
<tr><td colspan=5><?/*<center><b style='cursor:pointer;' OnClick="window.open('calc.php','calculator','width=400,height=500');">Calculator*/?></td><td><center><input type=submit value="Order"<?=(!$a)?" disabled":""?>></td></tr>
</form>
</table>
<br>
<? if ($lastone) { ?>
<br>

</td></tr></table>
<table border=1 bordercolor=#dddddd cellpadding=1 cellspacing=2 style='border:none;'>
<tr height=20 align=right><td><b>Unit</td>
<?

$me = mysql_query("SELECT eta FROM $TABLE[production] WHERE uid='$UID' AND u_of_w='u' ORDER BY -eta LIMIT 1") or die(mysql_error());
$maxeta = mysql_result($me,0,'eta');

for ($i=0;$i<$maxeta;$i++)
{
	echo "<td><center>".($i+1)."</td>\n";
}
echo "</tr><tr height=20>";
$lasteta=0;
while ($pi = mysql_fetch_assoc($prod))
{
	$lastone--;
	echo "<td align=right><b>".$productionarray[$pi[unit]][0]."</td>";
	$thisprod = mysql_query("SELECT *,SUM(number) AS total_num FROM $TABLE[production] WHERE uid='$UID' AND unit='$pi[unit]' GROUP BY eta") or die(mysql_error());
	while ($pi2 = mysql_fetch_assoc($thisprod))
	{
		for ($j=$lasteta;$j<$pi2[eta]-1;$j++)
		{
			echo "<td></td>";
			$lasteta++;
		}
			$lasteta++;
		echo "<td>".nummertje($pi2[total_num])."</td>";
	}
	echo ($lastone>0) ? "</tr><tr>" : "";
	$lasteta=0;
}

echo "</tr></table><table border=0 cellpadding=0 cellspacing=0 width=700><tr valign=top><td><br>";
}

include("footer.php");


